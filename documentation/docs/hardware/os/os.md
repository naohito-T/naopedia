# OS

## OSとは

コンピューターーシステムにおいてハードウェアとアプリケーションの橋渡しを行う。
より学問的に言うと
- ハードウェアを抽象化してアプリケーションのインターフェイスを提供する

>たとえば、外部記憶装置にファイルを書き込む場合、その外部記憶装置はSATA接続のハードディスクかもしれませんし、NVMe接続のSSDかもしれませんし、はたまたUSBメモリかもしれません。しかも、各ディスクのファイルシステムは全部違うかもしれません。そんな状況でもアプリケーションは書き込み先のファイルをfopenしてwriteするだけで、書き込み先のデバイスが一体何なのかを気にせず書き込むことができます。これが「ハードウエアを抽象化して、アプリケーションにインターフェイスを提供する」ということなのです

- 計算資源を複数のアプリケーションに分配する
>また、CPUは一般的に1コアで1つのアプリケーションしか動作させることができません。それでも、私たちはCPUのコア数より多くのアプリケーションを起動し、まるで同時に動いているかのように感じることができます。これは、OSがCPUの時間を細かい単位に分割し、各アプリケーションを切り替えつつ実行するよう調整しているからなのです。これが「計算資源を複数のアプリケーションに分配する」という機能の例です。

## OSの基本構造

- コマンドやライブラリ
- カーネル

カーネルはコンピューターーの基本的な操作を行う機能を格納したライブラリ群のようなもので、**コマンドやライブラリはこのカーネルの中にあるライブラリ(システムコール)を呼び出す。**
例としてlsコマンドはC言語で書かれているが、その中でgetdentsというシステムコールを呼びファイルのリストを取得している。
つまりプロセスはOS内のコマンドやライブラリを呼び出し、そのコマンドやライブラリはカーネル内のシステムコールを呼び出している。

---

ここからはオペレーティングシステムのコンセプトを理解する。

1. プロセス管理

- プロセス
プログラムの実行単位であり、CPU時間単位で割り振られる。状態（ステート）があり、現在処理中であるRunning状態だったり、実行可能状態であるReadyなどが存在。
CPUがプロセスを実行する場合、そのプロセスが持つメモリデータに対して演算を行う。
プロセスはテキストセグメントとデータセグメントからなる構造データをメモリ上に持っている。
**テキストセグメント**
プログラムの命令列
**データセグメント**
PDA (Processor Data Area)と呼ばれる、プロセッサの情報やプロセス管理用のデータ領域
データ領域と呼ばれる、定数等が置かれる静的領域と、通常の変数等が置かれるヒープ領域からなる領域
スタック領域と呼ばれる、一時的なデータ保管領域


---

2. スレッドと並行性

スレッド
CPUを利用するための実行単位で、最小処理単位の概念。


---

## ファイルディスクリプター(fdともいう)
[参考URL](https://christina04.hatenablog.com/entry/socket-base#:~:text=%E3%82%BD%E3%82%B1%E3%83%83%E3%83%88%E3%81%AF%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E9%80%9A%E4%BF%A1%E3%81%AB,%E3%81%A8%E3%81%97%E3%81%A6%E3%82%82%E4%BD%BF%E3%82%8F%E3%82%8C%E3%81%BE%E3%81%99%E3%80%82)

ソケットを扱う上で切り離せないのがファイルディスクリプター。
fdとは**ファイルやソケットなどを抽象化**した仕組み。
ファイルディスクリプターという名称だが、ファイルに限らず**標準入出力、ソケット、ブロックデバイス、ディスプレイなど何でも「ファイルを扱うように」扱える。**
オブジェクト指向のポリモーフィズムの考え方ですね。
Go言語でいうとio.Readerやio.Writerに近いです。抽象化された入出力によって汎用的な使い方ができます。

## fd番号

fdは単なる整数で、その数字で識別されます。fdはプロセス毎に管理されますが、そのうち0~2はあらかじめ決まっていて

0: 標準入力
1: 標準出力
2: 標準エラー出力
となってます。それ以降は新しくfdが必要となった時に小さい番号順で作られ、クローズされると同じ番号が再利用されます。

## fd保存場所

fdはプロセス毎に管理されるため、/proc/プロセス番号/fd/に保持されています。
また

`$ lsof -p プロセス番号`
で番号を確認できます。


## ソケット
[ソケットとポート番号のそれぞれの役割を知る](https://xtech.nikkei.com/it/pc/article/NPC/20070130/260044/)
[Webサーバにおけるソケット周りの知識](https://christina04.hatenablog.com/entry/socket-base#:~:text=%E3%82%BD%E3%82%B1%E3%83%83%E3%83%88%E3%81%AF%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E9%80%9A%E4%BF%A1%E3%81%AB,%E3%81%A8%E3%81%97%E3%81%A6%E3%82%82%E4%BD%BF%E3%82%8F%E3%82%8C%E3%81%BE%E3%81%99%E3%80%82)

ソケットを理解するとわかること
- TCPセッションの流れ
- ulimitでnofileを上げないとコネクション増加した時のToo many open filesが出るのはなぜか
- なぜサーバの待ち受けポートは1つで、クライアントのポートは接続するたびに新しいポートが必要なのか
- unix domain socketはなぜファイルパスを指定するのか

ソケットはネットワーク通信に用いる際のファイルディスクリプターです。
これはTCP/UDPのような外部ネットワークに繋がるインタフェースとしても使われますし、Unixドメインソケットのようなカーネル内部で完結するネットワークインタフェースとしても使われます。



コンピューターーがTCP/IPを使って通信をするとき、IPプロトコルやTCPプロトコルの機能は大抵、OSの機能として実現される。
一般にWebブラウザやメーラーといったアプリケーションプログラムはAPIと呼ばれる仕組みでOSの機能を呼び出している。
**ソケット(socket)はTCP/IPの機能を利用する時に使う標準的なAPIでポート番号はそこで使われる識別子**

- ソケットの経緯
>BSD UNIXはTCP/IPを使ったネットワーク機能を搭載していたうえに、プログラムのソースコードを無料で公開したので、BSD UNIXとソケットAPIはTCP/IPを使う通信ソフトを開発する際のリファレンス（基本となる手法）になりました。TCP/IPの普及に伴い、ソケットは通信ソフトがOSのTCP/IP機能を利用するAPIとしてデファクト・スタンダードの地位を確立しました。


ソケットはプロセスの持つ出入り口。プロセス間で通信を行う場合やプロセスからインターネットに繋ぐ場合の口となる。

## ソケット通信 HTTP通信違い
[かなり深く追求している](https://qiita.com/Kept1994/items/b28581f9cf2bd8383ef4)

HTTPはクライアントがリクエストすることによってサーバがレスポンスする。
クライアントが発信することから始まるため逆にサーバーがリクエストすることはない。
ソケット通信の場合は**サーバとクライアントが特定のポートを通じて双方向にリアルタイムで通信**することが可能。

---



---

---
1. POSIXの基礎
2. ネットワーキングコンセプト

---

## 標準入力/標準出力/

あらゆるプロセスには、stdin、stdout、stderrという3つの標準ストリームがあることをしる

[別の記事だけど参考になる(Node.jsでログを記録する方法)](https://www.twilio.com/blog/a-guide-to-node-js-logging-jp)

### 標準入力 [standard input] stdin

コンピューターの入力装置やOSが提供する**データ入力機能・経路**などを指し、多くのシステムではキーボード装置による利用者の文字入力が標準入力に設定されている。 システム上では “stdin” の略号で表されることが多い。

## 標準出力 [standard output] stdout

コンピューターの出力装置やOSが提供するデータ出力機能・経路などを指し、多くのシステムではディスプレイ装置による利用者への文字表示が標準出力に設定されている。 システム上では “stdout” の略号で表されることが多い。

topic
JSのconsole.logはこれにあたる


## 標準エラー出力

UNIXの命令やGMTの命令の多くはエラーメッセージを出力することがある。
これは標準出力（stdout）とは違う書き出し先に書き込まれる。これを標準エラー出力（stderr）という。

topic
JSのconsole.errorはこれにあたる

---

## 改行コード

対応OSと改行コードが違うということは、**プログラムを読み込めなくなることを意味する**

[参考URL](https://cprogram.net/line-feed-code/)

### 種類

改行コードには以下のものがある。

– **CR（Carriage Return キャリッジ・リターン）**
左端へ移動する・同じ行の先頭へ移動するという意味
実際には、「次の先頭行」に行くことで間違いではないのですが、あくまで操作としては「カーソルを左端の位置に移動する」ということです。
コードで書く場合は`\r`と記述します。
対応OS：Mac OS 9以前（現在ではあまり一般的でない）

– **LF（Line Feed ラインフィード）**
カーソルを次の行へ移動する
コードで書く場合は`\n`

対応OS : LinuxやUNIX（macOSX以降

– **CR + LF （Carriage Return キャリッジ・リターン + Line Feed ラインフィード）**
意味としては、カーソルを左端に移動し、次の行へ移動するという、後述のCRとLFの組み合わせ。
コードで書く場合は`\r\n`と記述する

対応OS：Windows OS

## UID

UIDとはUNIX系のOSで使用される、利用者識別用の番号のこと。


