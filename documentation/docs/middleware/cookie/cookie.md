# Cookie

[参考URL](https://www.kwbtblog.com/entry/2019/04/20/005423)  
[参考URL](https://www.ecbeing.net/contents/detail/235)

**Cookieはブラウザがパソコンのハードディスクに保存する小さなデータであり、簡易なテキストファイルのこと。**
サーバー（Rails）が**クライアントに一時的に情報を記録させるときに使用する**

## Overview

[Cookieについて](https://www.plan-b.co.jp/blog/marketing/13662/)

- クッキーとは、変数名とその値のペアのデータのこと
- クッキーはサーバー側で設定して、ブラウザにレスポンスとして送る
- 受け取ったクッキーはブラウザに保存される
- ブラウザが再度そのサイトにアクセスする際、保存されているクッキーをサーバーに送る
- ブラウザ側でクッキーに変数を追加したり、既存の変数の値を変更することもできる
- クッキーには有効期限を設定できる
- クッキーの有効範囲を、**ドメインやパスで絞ることができる**
- クッキーの有効範囲を、**ドメインやパスで絞った場合、そのクッキーを他のドメインやパスのサーバーから見ることはできない**

## Cookieの種類

クッキーには2種類ある
Cookieには1st party Cookieと3rd party Cookieがある。  
その違いはCookieの発行元になる。

- セッションクッキー（sessionと共に利用する）
  セッションクッキーは、Webサイトにアクセスしている間、ブラウザに一時的に作成され、ユーザーがサイトを離れると、セッションクッキーは削除される。
- 永続クッキー
  永続クッキーはユーザーがブラウザを閉じても削除されず、そのクッキーを作成したWebサイトにアクセスすると再度アクティブになります。永続クッキーは、Cookieのファイル内で設定された期間ブラウザに残る。

### 1st party Cookie

実際に訪れているサイトのドメインが発行しているのが1st party Cookie  
1st party Cookieはユーザーにブロックされにくいという特徴。  
そのため、3rd party Cookieに比べてユーザーをきちんとトラッキングすることが可能。  
しかし、一方でそのドメインからしか発行できないため、サイトを横断したCookieの付与はできません。

### 3rd party Cookie

訪れているサイト以外のドメインから発行されているのが3rd party Cookie  
たとえば、訪れたサイトにバナー広告が埋まっている場合、そのバナー広告はアドサーバーから配信されています。アドサーバーは訪れているサイトのドメインとは異なるドメインを持っているため、そのCookieは3rd party Cookieになる。

3rd party Cookieはサイトを横断したCookieの付与ができます。そのため、そのユーザーがどのサイトを訪れているかという情報を把握することができる。  
しかし、近年3rd party Cookieはブラウザによるブロック等の影響で有効期限がすぐに切れてしまうという問題

## Cookieの保存期間

>これまで Chrome の Cookie の有効期限に制限はありませんでした。1日でも、１か月でも、10年でも Cookie を発行する側の任意で決めることができました。
>しかし、2022年8月にリリースされた Chrome 104 以降、Cookie の有効期限は400日を上限とする仕様に変更されました。
>https://developer.chrome.com/blog/new-in-chrome-104/#more
>Cookie を発行する側が有効期限2年の Cookie を発行しようとしたとしても、ブラウザ側で自動的に400日に短縮されて保存されます

## Cookieを保存してはいけない国

とくにEU圏ではこのことが問題視され、GDPRという、Cookieを個人情報として取り扱い、勝手に取得してはいけないという法律まで制定されている。

はい、発行されたクッキーは、そのクッキーが設定されたドメインおよびパスに対してのみ有効です。他のドメインやサイトでは、そのクッキーは送信されません。

### クッキーのスコープ

クッキーのスコープは、以下の要素によって決定されます

1. ドメイン
  クッキーは、設定されたドメインに対してのみ送信される。
  たとえば、`example.com` で設定されたクッキーは `example.com` およびそのサブドメイン（`sub.example.com`）に対してのみ有効。
  他のドメイン（`another-example.com`）には送信されません。
2. パス
  クッキーは、設定されたパスに対してのみ送信される。
  `/path` で設定されたクッキーは `example.com/path` でのみ有効。
  デフォルトでは、ルートパス (`/`) が設定され、ドメイン内のすべてのパスに対して有効になります。

### タブやサイトの変更

1. 同じタブ内でサイトを変更した場合
  ブラウザのアドレスバーを使って異なるサイトに移動すると、新しいサイトに対してクッキーは送信されません。クッキーはそれぞれのドメインに対してスコープが設定されているため、異なるドメインに対しては無効です。
  ユーザーが `example.com` から `another-example.com` に移動すると、`example.com` のクッキーは `another-example.com` には送信されません。
2. 異なるタブやウィンドウで同じサイトにアクセスした場合
  同じドメインに対して設定されたクッキーは、異なるタブやウィンドウでも有効。
  ユーザーが `example.com` を2つの異なるタブで開いた場合、両方のタブで同じクッキーが送信されます。

- **クッキーのスコープ**: クッキーは設定されたドメインおよびパスに対してのみ有効です。他のドメインやパスには送信されません。
- **同じタブ内でサイトを変更した場合**: 異なるサイトに移動すると、新しいサイトには前のサイトのクッキーは送信されません。
- **異なるタブやウィンドウで同じサイトにアクセスした場合**: 同じドメインに対して設定されたクッキーは、異なるタブやウィンドウでも有効です。

## cookieが必要な理由

HTTP通信の問題点  
HTTP通信は1回1回の単発の通信なので、接続を維持し続けることができない（ステートレス）  
HTTP通信はユーザー識別の仕組みがないので**どのユーザーからの接続**かを判別することができない。  
なので、一連のHTTP通信で、ユーザー接続を維持し続けるには、何かしらの仕組みを実装する必要がある

解決方法
ユーザー認証完了後、サーバー側でユーザー識別子を発行する。
ブラウザへのレスポンスで識別子を送り次回以降ブラウザからサーバーへアクセスする際に、毎回その識別子をサーバーに送ることにより、サーバー側でどのユーザーからのアクセスかがわかるようにする。
そして、その識別子のやり取り方法の1つとして、クッキーを用いる方法がある。

httponlyオプション
httponlyは、HTTP通信でのみアクセスできるCookieを生成するためのオプションです。

このオプションを付けると、JavaScriptからのアクセスを完全に遮断することができ、サーバーサイドのRailsでしかアクセスできなくなります。
これにより、外部JavaScriptからのCookie盗聴を防ぎます。

- Cookieでも万全ではないことを理解しておく
Cookieへの保存は、外部からの攻撃を完全に遮断できるわけではありません。

JavaScriptで参照できるローカルストレージよりはマシなだけであって、Cookieのhttponlyオプションは、あくまで最低限のセキュリティだとお考えください。

## Cookieの実装問題点

仕様上、ブラウザ側でクッキーが見られて変更できるのでなりすましができてしまう。

## 上記の実装問題点解決方法

- サーバー側でユーザーIDではなく、暗号化されたユーザー識別子をクッキーとしてブラウザーに送る
- この暗号化されたユーザー識別子を、一般的に「セッションID」と呼ぶ
- ブラウザからサーバーにアクセスすると、サーバー側では受け取ったクッキーから「セッションID」を取得して、それから「ユーザーID」を復元してユーザーを特定することにより、接続を維持する
- ユーザー識別子は暗号化されているので、他のユーザーのユーザー識別子を生成してなりすますのは困難

## サブドメインでcookieを共有する

[参考URL](https://qiita.com/il-m-yamagishi/items/9aad5737c80d5bfd5eb8)

## クロスオリジン通信でのCookie共有設定

クロスオリジン通信でのCookie共有は双方に設定が必要。

**credentials（クレデンシャル）**
リクエストヘッダーのwithCredentials（ウィズ クレデンシャル）フラグをtrueにする。
withCredentialsは、クロスオリジンのクライアント資格情報を使用して、リクエストを行うことを許容するか否かを設定するフラグです。（デフォルトはfalse）

trueにすることで、
クロスオリジンリクエストの際に、Cookieを送信することができ、クロスオリジンレスポンスのCookieを受け取ることができます。

## クッキー(Cookie)とセッションの違い

小括として、クッキーとセッションの違いをまとめておきましょう。
クッキーもセッションも情報を保存するために使用されることには違いがありません。
違いとしては保存場所が挙げられます。クッキーはクライアント側のマシン（主にブラウザ）にのみ保存され、セッションはブラウザだけでなく、サーバーにも情報が保存されます。
また、保存の期間にも大きな違いがあり、セッションはユーザーがブラウザを閉じるか、サイトを離れると情報が削除されます。一方、クッキーには永続クッキーがあり、情報を保持し続けます。
さらに、大きなポイントとしてはセッションは無効にできませんが、クッキーは無効にすることができる。

## Set-Cookie

[参考URL](https://developer.mozilla.org/ja/docs/Web/HTTP/Headers/Set-Cookie)

Set-CookieはHTTPのレスポンスヘッダーで、サーバーからユーザーエージェントへクッキーを送信するために使用され、ユーザーエージェントはそれを後でサーバーに送り返すことができるようになる。  
複数のクッキーを送信するには、複数のSet-Cookieヘッダーを同じレスポンスで送信してください。

## cookie属性

>ウェブサーバーとウェブブラウザとの間でやりとりできる小さなデータとして「クッキー (Cookies)」というものがあります。このクッキーは属性を持たせることができるのですが、その中にはセキュリティを高めるための属性がいくつかあります。

### Secure属性

>Secure 属性がついたクッキーは HTTPS プロトコル上の暗号化されたリクエストでのみサーバーに送信され、安全でない HTTP では決して送信されない

### SameSite

[参考URL](https://www.ecbeing.net/contents/detail/235)  
[Chrome で SameSite=None に関する Cookieについての警告が表示される](https://laboradian.com/warning-about-cookie-samesite-none/)

Chromeがデフォルトでクッキーを`SameSite = Lax`として扱うようになる  
クロスサイトな状況でクッキーを発行させたい場合（埋め込みコンテンツなど）は、SameSite属性にNoneという値をセットする。
これで、クロスサイトでもクッキーが発行されます。そして警告にもあったように、この場合は必ずSecure属性もつける
つまり今後、httpでクロスサイトなクッキーを発行してはいけないということです。

SameSiteには3つの設定を行うことが可能で、`None、Lax、Strict`の3つとなる。
※これはセキュリティレベルの高さの指定になる

- None（なし）
- Lax（緩い）
- Strict（厳しい）

上記の順番でセキュア（CSRF）に対するセキュリティレベルを示している。
仕様が変更にある前まではSameSiteを指定していない場合、ブラウザ側ではNone（なし）として判断してWebサイトからのCookieの利用を許可しておりましたが、今回のGoogle Chrome 80からはSameSiteを指定しない場合、Lax（緩い）として取り扱う形となった。

## SameSiteなどの回避方法

Chrome84からCookieの属性であるSameSiteのデフォルト値がNoneからLax変更されたことにより、異なるオリジン間でCookieが受け取れなくなっていた。
明示的にSameSite=Noneを設定することでCookieを受け取れるようにはなるが、そうすると次はCookieの属性であるSecureも必須となる。

対応内容
>ローカル環境をSSLする必要があるのかと思ったらdevserverのproxyオプションで解決した。
>同一オリジン扱いになるのでCORS問題も解決できそう。

つまりproxyを立てて通信を行う（local）、devでも行う必要があるのか気になる。

[Next Http Proxy Middlewareで Next.js × Rust間のリクエストをproxyする](https://sayu-do.com/2022-2-3/196/)

## HttpOnly

HttpOnly属性は、サーバー側で付与してCookieを送信することで、JavaScriptからCookieにアクセスを行えなくするためのもの。  
ここ最近の主要ブラウザはサポートしている。そのためCookieに保存することが推奨されている（JWT）

## Cookie expires時間

**Cookieの法定タイムゾーンはGMT（グリニッジ標準時）と決められており、expiresはGMTで保存されます。**
**また、有効期限を判断するために使用されるタイムゾーンもGMTです。**
**GMTは日本時間マイナス9時間で、UTC（世界標準時）と一致します。**
