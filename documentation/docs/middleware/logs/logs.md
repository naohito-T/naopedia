# logs
[log level](https://en.wikipedia.org/wiki/Syslog#Severity_level)
[log perfectガイド](https://betterstack.com/community/guides/logging/how-to-install-setup-and-use-pino-to-log-node-js-applications/)

ロギングはプログラムで何が起こっているかを把握するためのもっとも効果的な手法の1つ。  
さらに、構造化ログにより、トレースとフィルタリングが改善される。


log監視ツールが色々あるためそれをまとめる。

ログと言っても色々ある
- メトリクス収集
- ロギング
- 可視化
- アラート通知

## ユビキタス

- メトリクス（測定・基準・尺度・計量）などを意味する。
[metrics](https://e-words.jp/w/%E3%83%A1%E3%83%88%E3%83%AA%E3%82%AF%E3%82%B9.html)

## Tips
[zozoでの](https://techblog.zozo.com/entry/zozotown-backend-monitoring)

## ロギング行為の基本
[参考URL](https://expressjs.com/ja/advanced/best-practice-security.html)

>開発環境では許可されることが、実稼働環境では許可されないことがあります。例えば、開発環境ではデバッグのためにエラーの詳細なロギングを実行できますが、同じ動作が実稼働環境ではセキュリティー上の問題となります。

- 開発環境と本番環境で分ける。
- 本番で出すことはセキュリティー状の問題となってしまう場合がある

## ログレベル

おそらくほとんどのライブラリで使用するのではないか。
`all < trace < debug < info < warn < error < fatal < mark < off`

## 開発者のためのロギング
[参考URL](https://qiita.com/yukin01/items/33f20fc6efef3e783c85)

>一般的に、ある時点で起こったイベントとその時刻を記録することをロギングと呼びます。Web アプリケーションの場合は、Web サーバーのアクセスログやアプリケーションサーバーの実行ログ、及びエラーログなどを記録して、ストレージやログ集約サービスに永続化し、活用する仕組み全体を指していることが多いです。

ログを収集する目的はさまざまですが、いくつか例をあげると次の通りです。
セキュリティ要件を満たすためにアクセスログを長期間保存したい
不具合を調査するためにアプリケーションのエラーログを検索したい
アクセスログの統計情報をとってダッシュボードに表示したい

## ログの出し方

>基本的にログを出す時は流れでわかるようにせず1行で完結する形が好ましいです
>（DB: liver id: xx、DB: token: xx、みたいに、あと行を分けず全部1行で出していいと思います）
>現在は複数プロセスが一つのログに前後混ざることがないですが
>そういう処理を作る場合にこの書き方に慣れていると処理を追いにくい、追えないログになってしまいます
>またgrepなどで検索する際にも前後を出さないといけなくなってしまいます

>細かいところはリファクタリングのフェーズでいいと思いますが
>loggerの機能でできる部分と合わせて日時、ログ種別(info,warning,error)、PID、ログ内容、あとはログ発生タスクやUtilなどがわかるようになっていると検索性も良くなるので意識してもらえるといいと思います

## 3つのフェーズで導入する

- ログ出力
アプリケーションがどういう形でログを出力して、どう記録されるか
- ログローテート
無尽蔵に増えるログに対してどう対処するか
- ログ集約
どうやってストレージや外部サービスにログを永続化するか

## RestAPIでのログの出しかた。

アプリケーション全体で繰り返したくないログ行がある。  
HTTP APIを提供するアプリケーションの場合、着信要求ごとに常にログ行があると便利です。  
このようにして、一部のエンドポイントでこのログ行が忘れられたり、ログが構造的に異なったりすることを回避します。

これを実現するために、`Express.js`ミドルウェアをプレリクエスト ハンドラーとして定義する。

※デフォルトでは、すべてのヘッダーとクエリパラメーターがログに記録されます。
そのため、アクセストークンを送信する際には注意してください。認証に関する後の投稿で、デフォルトのシリアル化を変更して、ログからアクセス トークンを除外します。

## logでのトランスポート

ログでのトランスポートは、ログメッセージを処理して出力するための外部プログラムやサービスを指す。  
通常、ログメッセージは標準出力（stdout）に送られますが、トランスポートを使用することで、これらのログメッセージをさまざまな形式で加工したり、異なる出力先（たとえば、ファイル、リモートのログ収集サービスなど）に送ったりすることができる。

Pinoでは、pino-prettyのようなトランスポートを使用して、ログの出力を読みやすくフォーマットすることが一般的な使用例です。しかし、Pino v7以降では、トランスポートの扱いが変更され、子プロセスとして実行されるようになりました。これにより、メインのアプリケーションプロセスのパフォーマンスに影響を与えずに、ログ処理を行うことができます。

```ts
const pino = require('pino');

const logger = pino({
  name: 'nid-backend',
  level: process.env.NODE_ENV === 'production' ? 'info' : 'debug',
});

logger.info('This is an info message');
```

この方法では、ログメッセージは標準出力に送られ、トランスポートを使用する場合に見られる子プロセスの起動は行われません。これにより、特定の実行環境での互換性の問題を避けることができます。

---

## シングルトレーシング

モノリスなアプリケーションの対してトレーシングすること（一枚岩）

## 分散トレーシング
[参考URL（Goでの実装）](https://tech.every.tv/entry/2021/12/14/120000)

分散トレーシングとは分散されたアーキテクチャアプリケーションを監視するための手法。
マイクロサービスのような複数システムから構成されるアーキテクチャでは**複数のサービスを跨いで処理が動くため、全体の振る舞いを把握することが難しい課題。**
。 また、障害発生時に原因を特定することも困難です。 分散トレーシングの手法を用いることで、サービス間をまたいだ処理の計測や可視化が可能になり、それら課題の解決に繋がります。


### 用語

- トレース（Trace）
    トレースは**アプリケーションがリクエストを処理するのに費やした時間**と、このリクエストのステータスを追跡するために使用されます。各トレースは、ひとつまたは複数のスパンで構成されます。

- スパン（span）
    スパンは、特定の期間における分散システムの論理的な作業単位を表します。複数のスパンでトレースが構成されます。

各サービスにおける処理の単位がスパンで表され、複数のスパンで構成される一連の全体処理がトレースで表されます。

## DatadogとSentryの違い
[両方導入している会社の話](https://tech.visasq.com/optimize-operation/)

Datadogはアラートモニタリングサービス。
Sentryはアプリケーションモニタリング&エラートラッキングサービス。
一部重複する機能はあるが、Sentryを導入することでユーザー体験や開発効率を向上させることができると思う。
