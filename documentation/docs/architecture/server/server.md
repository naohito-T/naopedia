# Server

サーバサイドでの設計思想を記述する。

## サーバサイドで実装するべき機能

ロギング機能
[参考URL](https://www.twilio.com/blog/a-guide-to-node-js-logging-jp)

rateLimitでリクエスト回数を決める
f5対策？

リクエストの検証をする

json parse機能
jsonの検証

- 開発編

## シングルプロセスとシングルスレッド

ほとんどのWebサーバーと同様に、Ruby on Railsアプリケーションは同時に複数のリクエストを処理することができます。具体的には、以下のような構造で動作します：

### シングルスレッドとマルチスレッドの違い

1. **シングルスレッドモデル**:
   - **プロセスごとに1リクエスト**: シングルスレッドのWebサーバー（例：WEBrick）は、各リクエストを個別のプロセスで処理します。そのため、1つのプロセスは1回に1つのリクエストしか処理しません。
   - **安全性**: このモデルでは、各プロセスが独立して動作するため、スレッドセーフなコードを書く必要がなく、リソースの共有による問題を避けることができます。

2. **マルチスレッドモデル**:
   - **スレッドごとに1リクエスト**: マルチスレッドのWebサーバー（例：Puma）は、複数のスレッドを使用して同時に複数のリクエストを処理します。1つのプロセス内で複数のスレッドが動作し、各スレッドが個別のリクエストを処理します。
   - **効率性**: これにより、同時に多くのリクエストを効率的に処理できるため、応答性が向上します。

### Railsの動作

- **デフォルト設定**: Railsアプリケーションはデフォルトでシングルスレッドモードで動作します。ただし、Pumaなどのマルチスレッドサーバーを使用することで、Railsをマルチスレッドモードで動作させることができます。
- **マルチスレッド対応**: Railsはマルチスレッド対応しており、適切な設定を行えば、マルチスレッド環境でも安全に動作します。ただし、スレッドセーフなコードを書くことが重要です。

### 実際の動作例

以下は、Pumaを使用してRailsアプリケーションをマルチスレッドで動作させる設定の例です。この設定により、Railsアプリケーションは同時に複数のリクエストを処理できるようになります。

```ruby
# config/puma.rb

workers ENV.fetch("WEB_CONCURRENCY") { 2 }
threads_count = ENV.fetch("RAILS_MAX_THREADS") { 5 }
threads threads_count, threads_count

preload_app!

rackup DefaultRackup
port ENV.fetch("PORT") { 3000 }
environment ENV.fetch("RAILS_ENV") { "development" }

on_worker_boot do
  ActiveRecord::Base.establish_connection if defined?(ActiveRecord)
end
```

この設定では、Pumaが2つのワーカーと5つのスレッドで動作するため、同時に最大10のリクエストを処理することができます。

### 結論

- **シングルスレッドモード**: 各リクエストは独立したプロセスで処理される。
- **マルチスレッドモード**: 複数のスレッドが並行してリクエストを処理する。
- **Railsのサポート**: Railsはデフォルトでシングルスレッドですが、Pumaなどを使用することでマルチスレッドで動作させることができる。

これにより、Railsアプリケーションは必要に応じて効率的にスケールさせることが可能です。
