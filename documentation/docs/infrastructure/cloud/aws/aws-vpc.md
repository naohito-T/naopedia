# VPC(Virtual Private Cloud)

## VPCとは

VPCは、主に**プライベートなリソース**（例：データベースサーバーやバックエンドアプリケーション）を保護し、インターネットから隔離するために使用される。  
フロントエンドは一般的に公開されるコンポーネントであり、ユーザーから直接アクセス可能な部分です。そのため、VPC内にフロントエンドを配置する必要はほとんどない

一般的なアーキテクチャでは、フロントエンド（Next.jsなどのLambda関数を含む）はパブリックなインターネットに接続される場所に配置されます。一般的に、フロントエンドはクライアントのブラウザから直接アクセスされ、ユーザーに対してウェブサイトやアプリケーションのコンテンツを提供します。

一方、バックエンドのリソースやデータベースなどは、セキュリティ上の理由からVPC内に配置することが一般的です。VPC内のリソースはインターネットから直接アクセスできないため、より高いセキュリティレベルでアクセス制御が可能となります。

ただし、特定の要件やセキュリティ上の懸念がある場合は、フロントエンドをVPC内に配置することも考えられる。  
一般的なケースではフロントエンドはVPC外に配置することが多い。  
適切なアーキテクチャを選択するためには、具体的な要件やセキュリティポリシーを考慮し、適切な設計を行うことが重要

## VPCにフロントエンドは配置するべきなのか

一般的に、フロントエンド（プレゼンテーション層）はパブリックなインターネットに配置され、ユーザーから直接アクセスできるようになっている。  
一方、バックエンド（アプリケーション層）とデータベース（データ層）はセキュリティ上の理由からVPC内に配置されることがよくある。

つまり、三層アーキテクチャを採用している場合でも、フロントエンドはVPC外に配置されることが多い。  
フロントエンドはクライアントから直接アクセスされる部分であり、インターネットからのアクセスを受け付ける必要があるため。  
一方、バックエンドとデータベースは、セキュリティを高めるためにVPC内に配置されることが一般的

## VPCエンドポイント（AWS PrivateLink）

VPCと他のVPC外のサービス間の通信を可能にするサービスで、たとえばLambdaとParameter Store間にVPCエンドポイントを作成することで、LambdaからParameter Storeにアクセスが可能になる。  
インターフェイスエンドポイントとゲートウェイエンドポイントの2種類があり、前者は有料ですが後者は無料です。S3とDynamo DBではゲートウェイエンドポイントが利用できる。

## VPCのCIDR (Classless Inter-Domain Routing) ブロックは、一般的に`10.0.0.0/16`がよく使用される理由

1. **プライベートなIPアドレス範囲**: CIDRブロック`10.0.0.0/8`はプライベートなIPアドレス範囲に属しています。  
これは、インターネット上の他のデバイスとの衝突を避けるために、プライベートネットワーク内でのみ使用することを意味します。

2. **大規模なIPアドレス範囲**: /16サブネットは、65,536のIPアドレスを含む広範なアドレススペースを提供します。これにより、VPC内のリソースに対して十分なIPアドレスを割り当てることができます。

3. **AWSの推奨設定**: Amazon Web Services (AWS) は、デフォルトで新しいVPCを作成する際に、CIDRブロック`10.0.0.0/16`を使用します。これにより、多くのユーザーが同じCIDRブロックを利用することになり、VPC間でのIPアドレスの競合を防ぎます。

4. **CIDRの慣例**: CIDRブロック`10.0.0.0/16`は、IPv4アドレスの範囲内で一般的に使用される慣例的な選択です。他のプライベートなIPアドレス範囲（たとえば、172.16.0.0/12や192.168.0.0/16）も利用されますが、10.0.0.0/16がもっとも広範で一般的です。

ただし、必ずしも`10.0.0.0/16`を使用する必要はありません。VPCのサイズや要件に応じて適切なCIDRブロックを選択することが重要です。複数のVPCを設定する場合は、異なるCIDRブロックを選択してIPアドレスの競合を回避する必要があります。

## サブネット

サブネットはネットワークレベルでのセグメンテーションを提供する

## ルートテーブル

サブネット間の通信経路を設定するためににルートテーブルという機能がある。  
**すべてのサブネットにルートテーブルを作成する必要がある。**  
※ただし、複数のサブネットが同じルートテーブルを共有することは可能。  
※public subnetには共通のルートテーブルを設定するのが慣例

- 送信先
  どこに接続するかという情報。送信先はIPアドレスを指定する

- ターゲット
    どこを経由するかという情報

### デフォルトで作成されるルート

`10.0.0.0/16 local`というルートテーブルのエントリは以下の意味を持っています

1. **10.0.0.0/16**:
   これはCIDR表記と呼ばれるもので、特定のIPアドレスの範囲を表しています。`10.0.0.0/16`は`10.0.0.0`から`10.0.255.255`までのIPアドレスの範囲を指定しています。`/16`は最初の16ビットがネットワークアドレスで固定されており、残りのビットがホストアドレス部分となります。これにより、65,536個の異なるIPアドレスが得られます。

2. **local**:
   このルートエントリはVPC内でのローカルルーティングを意味しています。言い換えれば、このIPアドレス範囲内のどのIPアドレス宛に送られたトラフィックも、同じVPC内の対応するIPアドレスにルーティングされます。

具体的には、このルートエントリがあることによって、VPC内の任意のリソース（EC2インスタンス、Lambda関数など）が`10.0.0.0/16`内の任意の他のリソースに通信できるようになります。また、このエントリはVPCが作成される際に自動的に作成されるデフォルトのルートエントリです。

### ルートテーブルの疑問

>public subnetに紐づいているnatがあるとする
>private subnetのルートテーブルがVPC外へアクセスする場合は

>private subnet → public subnet → nat
>or
>private subnet  → nat
>どっちなのか？

回答
`private subnet → NAT` のルートを使用します。  
実際には、private subnetに関連付けられたルートテーブルに、インターネットまたはVPC外部へのトラフィックをNATゲートウェイ（またはNATインスタンス）にルーティングするエントリ（通常は `0.0.0.0/0` で指定される）を設定します。

したがって、トラフィックのルートは以下のようになります：

```
private subnet → NAT → Internet
```

ここで、NATはpublic subnetに配置されますが、トラフィックは直接NATゲートウェイまたはNATインスタンスにルーティングされ、その後インターネットにルーティングされます。したがって、「private subnet → public subnet → NAT」のように、public subnetを経由する明示的なステップは存在しません。

## NAT(Network Address Translation)

VPCの内部から外部に通信を行うときプライベートIPだけの情報をパブリックIPに変換する仕組みのことをNATと呼ぶ  
NATゲートウェイはパブリックなサブネットに対して作成する

## 0.0.0.0/0とは

`0.0.0.0/0` はCIDR表記法を用いてIPアドレス範囲を示すもので、インターネットプロトコル（IP）におけるすべての有効なアドレスを表す。  
具体的には、IPv4アドレス空間内のすべてのアドレスを含みます。

ここで、`0.0.0.0` は起点となるIPアドレスを示し、`/0` はサブネットマスクを示します。サブネットマスクの `/0` は、サブネットに関連付けられているビット数を示しています。`/0` は0ビットをサブネットに関連付けることを示しており、これによりすべてのIPアドレスがこの範囲に該当することになります。

AWSや他のネットワーク環境でのルートテーブル設定において、`0.0.0.0/0` のルートを設定することで以下のような効果を持ちます:

1. **すべての外部トラフィックのルーティング**: このルートを使用して、ネットワーク外部へのトラフィックを特定のターゲット（たとえばインターネットゲートウェイやNATゲートウェイ）にルーティングすることが可能。

2. **デフォルトルート**: 通常、`0.0.0.0/0` ルートはデフォルトルートとして使用され、特定のルートが設定されていないすべてのIPアドレス範囲へのトラフィックをハンドリングします。



## セキュリティ

AWS VPC GUIのセキュリティについて



