# Stripe

[Stripe Docs](https://stripe.com/docs/stripe-cli)  
[Stripe card Docs](https://stripe.com/docs/testing#cards)

## Overview

決済代行サービス（類似サービスとしてはPayPalがある）
stripeのAPIを使うと、自身のサービスの決済処理を担ってくれる。

ユーザーにお金を請求してその支払を受け取りたい！
「買切り」や「定額プラン」を設定して請求したい！

といったことが可能となる。
>私がstripeの特に良いと思ったところは、ユーザーがstripeのアカウントがなくても支払ができるということです。

localで3D secureをしたい

3dセキュアは本人認証後、Stripeに送信されStripeで認証が取れたことを確認した後、Webhookでどこかに送信する流れ、
そのためapi側ではwebhookを受けた後、その処理をする必要がある。
localではそれができないが、Stripe CLIを使えばそれを実行できる。

## Stripeを導入するにあたり検討する

[タイミーの場合](https://tech.timee.co.jp/entry/2020/12/10/131108)

## Stripe拒否コード

[Stripe拒否コード](https://docs.stripe.com/declines/codes?locale=ja-JP)

## サブスクリプション

[Stripe のサブスクリプション（すばらしいblog）](https://tech.actindi.net/2021/03/02/083000)
[Stripe Subscription 開始パターンごとの作成方法まとめ](https://qiita.com/phigasui/items/8bdc20ecd46a0d504bec)

サブスクリプションに関連するリソース
[![Image from Gyazo](https://i.gyazo.com/a0a696f408a19c12cad73bab1c50e674.png)](https://gyazo.com/a0a696f408a19c12cad73bab1c50e674)

| リソース                    | 概要                                                                                                                                              |
|-------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------|
| 顧客(Customer)          | Subscription の購入者。カード番号を保持するのに必須で、Subscription を作るのに必須。                                                                               |
| 製品(Products)          | 販売するサブスクリプション。名称や料金など設定する。料金の保存場所的なリソース。                                                                                           |
| 料金(Price)             | サブスクリプションの販売価格。Products に対して複数設定可能で請求金額と請求間隔を設定する。Subscription を作るのに必須。                                                   |
| サブスクリプション(Subscription) | 販売するサブスクリプション。状態を持ち支払いに関連して状態遷移する。                                                                                                   |
| 請求書(Invoice)         | サブスクリプションに対する請求。顧客にサブスクリプション料金を請求するタイミングで自動的に作られる。明細、税率、支払いの合計金額が記載される。                                                  |
| PaymentIntents          | 顧客の支払い処理。請求に対する顧客側から見た記録を保持する。状態を持つ。                                                                                          |
| 税率(TaxRate)           | 請求に加算する税率。Subscription を作成するときに default_tax_rates で指定してやると適用される。                                                                      |
| クーポン(Coupons)           | 割引クーポン。Subscription を作成するとき coupon に指定すると適用され、割り引かれる。定額または割引率で設定する。割引期間も設定できる。税率を設定している場合、割引後の請求額で税金が計算される |
| Charge と Transaction    | Invoice に対して、支払いが発生すると、ワンショットの決済の様に Charge が作成される。Charge の balance_transaction を見ると、その決済手数料がわかる。                                  |

### サブスクリプションの状態

[![Image from Gyazo](https://i.gyazo.com/79f3662e9767a38139c6c38e6738fc84.png)](https://gyazo.com/79f3662e9767a38139c6c38e6738fc84)

| 状態               | 概要                                                                 |
|--------------------|--------------------------------------------------------------------|
| trialing           | Subscription 試用期間。まだ請求してない。                                    |
| active             | Subscription が有効な状態。直近の請求に対する請求が成功している。                 |
| incomplete         | Subscription 作成時の請求が失敗した状態。                                 |
| incomplete_expired | 作成時の請求に失敗し、その後 23 時間以内に支払われなかった状態。                   |
| past_due           | 直近の請求が失敗している状態。リトライを試みている。                                  |
| canceled           | Subscription がキャンセルされた状態。自動的な定期請求が止まる。                     |
| unpaid             | 直近の請求が失敗し、リトライも成功しなかった状態。請求書は作成されるが、自動的には請求されない。 |

### サブスクリプションの更新について

[【Stripe】サブスクリプションの支払いタイミングが特定日時においてズレる問題について(月末版)](https://tech.stmn.co.jp/entry/2020/09/25/173008)  
まず起点の時間を把握しておく必要がある。  
Stripeでは毎月・四半期・毎年などのサイクルを指定することができ、起点からそのサイクルに則って開始される。

- billing_cycle_anchor
  >billing_cycle_anchorとは支払い開始の起点となる日時のことです。たとえば、毎月1日に決済したい場合、サブスクリプション作成時にbilling_cycle_anchorに翌月の1日を指定することで、毎月1日払いを実現することが出来ます。特に指定をしなければ、サブスクリプション作成時刻 = billing_cycle_anchorとなります。

### サブスクリプションの次回以降の支払い日時を変更する方法

次回以降の支払い日時を変更する方法としてtrial_endを使用します。  
trial_endは本来であればトライアル期間を設定するために使用するパラメーターですが、支払い日時を変更する用途でも使用できます。

### サブスクリプション継続決済

基本的にイベントは`update`が発行される。  
しかし一度サブスクリプションをキャンセルした後に、再度入り直すとイベントはcreateになる。

## インボイス

Stripeにおけるインボイスは、顧客に対する請求や決済を管理するためのひとつの手段。  
Stripeのインボイスは柔軟性が高く、異なる支払いシナリオやビジネスモデルに応じて設定することが可能。  
具体的には、Stripeのインボイスは自動的な決済と手動決済の両方のケースに対応している。

### Stripe インボイスの基本

1. **自動的な決済**
一般的にStripeを使用している多くのサービスでは、サブスクリプションや定期的な支払いがあり、これらは顧客が事前に支払い方法（例：クレジットカード）を登録しており
インボイスが発行されると自動的にその登録された支払い方法で料金が決済される。  
この場合、インボイスは主に記録として機能し、顧客への支払い詳細の確認や、会計処理のために用いられます。

2. **手動での支払い**
一部のケースでは、インボイスが発行された後、顧客が指定された支払い期限までに自ら支払いを行う必要がある。  
この方式は、通常、B2B（ビジネス間取引）でよく見られる。  
ここで、顧客はインボイスに記載された支払い手順にしたがって、オンラインでの支払い、銀行振込、または他の方法で支払いを完了する。

### インボイスの送付と決済プロセス

- **インボイスのメール送信**
  - Stripeでは、インボイスが生成されると、顧客に自動的にメールで送信される。
    このメールにはインボイスの詳細と、支払いを行うためのリンク（オンラインで支払いを完了するためのページへのリンク）が含まれている場合がある。

- **自動決済の通知**
  - 自動決済を行う設定の場合、顧客はメールでインボイスを受け取ると同時に、そのインボイスが登録されたカードで自動的に支払われたことを通知されることが一般的。

### 考慮すべき点

- **カード情報の更新**:
  - 顧客のカード情報が有効期限切れになっている場合や、その他の理由で決済が拒否された場合、多くのサービスではカード情報の更新を求める通知が行われます。これは、サービスの中断を避けるために重要です。

- **セキュリティ**:
  - 支払い情報の取り扱いには、常に高いセキュリティ基準を遵守することが重要です。StripeはPCI DSS準拠を実施しており、セキュリティの観点から信頼性が高いです。

Stripeのインボイス機能は非常に柔軟で、自動的な決済だけでなく、手動での支払いを求める場合にも対応できるため、さまざまなビジネスモデル

## 拒否コードの見方

[Stripe Docs:拒否コード](https://docs.stripe.com/declines/codes)

まず大元として支払いが失敗する理由は3つある

- カード発行会社による支払い拒否
- ブロックされた支払い
- 無効なAPIコール

---

## 実装関連

### Webhookの実装

基本は冪等で実装するべき（Stripeは何度も送信してくる可能性があるため）  
エラーレスポンスを返してしまうと、Stripeが何度も試行してしまうのでそこも考慮すべき

### RailsでのStripeの実装

[参考URL](https://qiita.com/tomokazu0112/items/89f69c47761ac782ce13#%E9%A1%A7%E5%AE%A2%E7%99%BB%E9%8C%B2)

顧客情報をstripeに登録し、その際に作られた顧客IDを中心にその他の課金等の処理を実行する
というのが実装の方針となる。

>それはなぜかと言うと、この顧客ID（cus_xxxxxxxxxxxxxx）を取得してしまえば、その顧客に対して定期課金や登録しているクレジットカードの削除などの処理を行えば良いからです！

## Stripe APIを利用するための準備
