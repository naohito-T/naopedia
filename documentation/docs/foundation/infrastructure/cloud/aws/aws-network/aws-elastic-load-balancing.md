# AWS Elastic Load Balancing(ELB)

[リファレンス](https://docs.aws.amazon.com/ja_jp/elasticloadbalancing/latest/application/introduction.html)

## Overview

Elastic Load Balancing（以降、ELBと表記）は、フルマネージド型の負荷分散サービス。  
ELBはAWSにおける負荷分散サービスの総称で、用途に応じて4つのロードバランサーが用意されている。

- Application Load Balancer（以降、ALBと表記）
- Network Load Balancer（以降、NLBと表記）
- Gateway Load Balancer（以降、GWLBと表記）
- Classic Load Balancer（以降、CLBと表記）

ELBは複数台のEC2インスタンスやLambda関数に処理を振り分けたい場合に有用なサービスで、最大のとkl雨長は高い拡張性を備えていること。

オンプレミスでは、ロードバランサーを用意する場合、負荷分散専用の機材を用意するか、サーバーに負荷分散機能を持たせるソフトウェアを組み込むことでロードバランサーとして構築する必要がある。  
どちらの場合でも、処理能力にはハードウェアの限界があり、自動的な拡張には対応できない。  
そのため、予想される負荷に対して充分な性能や台数をあらかじめ確保しておく必要がある。  
ELBでは**ハードウェアの制約を受けずに**負荷状況に応じて自動的にスケーリングするため、とくに意識することなくシステムの信頼性を担保できる。

## ELBの基本用語

[![Image from Gyazo](https://i.gyazo.com/886ad2abd481c07a0b154dee47bd3adc.png)](https://gyazo.com/886ad2abd481c07a0b154dee47bd3adc)

### リスナー

外部からアクセスするプロトコルとポートを指定して接続リクエストをチェックする  
1つのロードバランサーに対して最小1個、最大10個のリスナーを設定できる。

## リスナールールとアクション

リスナールールとは、受信したトラフィックの中身を判定する条件のこと。  
HTTPヘッダーや送信元IPアドレスなどに基づき、異なるアクションを設定できる。  
複数のリスナールールを設定し、どのルールを優先するか優先度を設定できる。  
リスナールールに応じて実行できるアクションは大きく分けて5種類ある

- メンテナンス用などに利用する「固定レスポンス」
- HTTPのリクエストをHTTPSに転送する「リダイレクト」
デフォルトでは、ターゲットグループへ転送するアクションが設定されます。

### ターゲットとターゲットグループ

ターゲットとは、ELBがトラフィックを転送するリソースやエンドポイント（AWSサービスに接続するためのURL）などのこと。  
EC2インスタンスやLambda、IPアドレスなどを指定可能。  
ひとつのELB配下で管理されるターゲットの集合のことをターゲットグループと呼ぶ。  
また、ターゲットグループは、ターゲットの死活監視をおこなうヘルスチェックという機能も備えています。 ターゲットのEC2インスタンスに異常が発生した場合、そのEC2インスタンスはヘルスチェックに失敗します。ヘルスチェックに失敗したEC2インスタンスはELBから切り離されるため、正常なインスタンスのみに通信を転送することができ、システムの可用性が向上します。

### SSLターミネーション

リスナーにSSL証明書を設定し**ELBでSSL認証を終端する機能**  
クライアントからのSSL（HTTPS通信:ポート443番）リクエストをELBにてSSL認証を行い、ターゲットグループに属するEC2インスタンスに対してはSSLではなくHTTP通信（ポート80番）を行います。  
ロードバランサーとEC2インスタンス間はSSL通信を行わないため、**EC2インスタンスの負荷を軽減するメリット**があります。SSL証明書はAWS ACMを利用して無料で発行できます。

### スティッキーセッション

同一セッション中のユーザーリクエストを同じターゲットに振り分ける機能です。 サーバーがセッションを管理するために発行したCookie(Webサーバーがクライアントに一時的にデータを保存させる仕組み)の情報をロードバランサーが読み取り、直前にアクセスしたターゲットへ導きます。 スティッキーセッションで利用するCookieの生成元は、ELBまたはアプリケーションのいずれかを選択できます。

[![Image from Gyazo](https://i.gyazo.com/5c627e4a45b5555e05577675e68fcc0f.png)](https://gyazo.com/5c627e4a45b5555e05577675e68fcc0f)

### Pre-warming（暖機運転）

ELBを事前にスケール（Pre-warming）させておく操作のこと。  
ELBはリクエストの増加に伴って自動的にスケールアウトしますが、急激にアクセス要求されるとELBのスケールアウトが間に合わず、サービスが一時的に利用できなくなる可能性があります。そこで、あらかじめ申請を行い、サービスの利用不可を回避することが可能です。

## ELBのメリット

導入することでのメリットは次の通り

### サービスの負荷を分散できる

ELBは、トラフィックを複数のターゲットに分散して転送することで、システムの可用性・耐障害性・信頼性などを高めます。

### サービスを常時モニタリング

ELBは、ヘルスチェック機能によりターゲットをリアルタイムにモニタリングしています。ターゲットに異常が発生したことを素早く検知し、正常稼働しているターゲットにだけトラフィックを転送します。 

### 自動的なスケーリング

ELBは、トラフィックの増加に応じて自動的にスケーリングするため、事前にインスタンスを複数台準備しシステムの冗長化をするHAクラスタリングを行う必要はありません。

### 初期コストを抑えやすい

従量課金制のため、初期費用や基本料金が発生しません。そのため、ハードウェア、ソフトウェアのロードバランサーよりも低コストで導入できます。

## ALB(アプリケーションロードバランサー)

レイヤー7（アプリケーション層）で動作するロードバランサー  
レイヤー7はOSI参照モデルの7層目を指す。  
ALBが対応するプロトコルは`HTTP、HTTPS`で、クライアントとロードバランサー間のSSLターミネーションをサポートしている。  
ELBの中ではもっとも多機能であり、パブリックサブネットにALBを配置し、プライベートサブネットにEC2やRDSなどのリソースを配置する、いわゆるWeb3層アーキテクチャなどさまざまケースで利用されている。

[![Image from Gyazo](https://i.gyazo.com/5bfb3dd4bf471413f23c5b5db1640591.png)](https://gyazo.com/5bfb3dd4bf471413f23c5b5db1640591)



















## ALBとELBの違い
[参考URL](https://www.wafcharm.com/jp/blog/difference-between-alb-and-elb/)

ELBとは「Elastic Load Balancing」の略称で、元々はこのELBがAWSにおけるロードバランシングサービスだった。  
しかしのちにALBが追加オプションとして開発された際に、ELBはその名称を「Classic Load Balancer（CLB）」に変えることになる。
そしてALBとCLBのサービスをまとめた総称として、ELBが使われるようになったのです。
さらに今ではNetwork Load Balancer（NLB）も追加され、その内容がさらに充実しています。
つまりELBとは、ALB、CLB、NLBという3種類の魅力的なロードバランサーを持つAWSのロードバランシングサービスの総称のこと

## ALBの特徴

- **レイヤー7（アプリケーションレイヤー）**での動作
- 新たにWebSocketとHTTP/2をサポート
- 最新のアプリケーションアーキテクチャを対象
- ターゲットグループにルーティングが行える
- 複数のアベイラビリティーゾーンの利用

## レイヤー7での動作について

旧来のELBはロードバランサーとして、レイヤー4のトランスポート層と、レイヤー7のアプリケーション層の両方で活動していた。
レイヤー4ではネットワークパケットの内容を細かく精査することなく負荷を分散し、レイヤー7ではパケット内のHTTPとHTTPSといった情報にアクセスしてより効率的な負荷分散を実行します。

一方でALBはレイヤー7だけで機能するロードバランサーであり、ELBとは違ってアプリケーション層に特化するスタイルを取っています。
そのためより便利で使いやすい機能の実装や追加が可能となり、全体のサポート力が高まることになったのでしょう。

## API GatewayとALBの比較

[HTTPSの終端：API GatewayとALBの比較とセキュリティ上の考察](https://zenn.dev/mizuba/articles/a3e47dd750bee6)
