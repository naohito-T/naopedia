# AWS SQS

キューサービス

## クウォーター

SQSの標準キューは1秒あたり無制限のAPI実行をサポートしている。  
しかし他に考慮する必要があるとすれば、**AWSアカウントごとにリージョンの同時実行数が設定されている**ため、設定を見直す必要などもある。  
※上記を言い換えると、どんなに大規模な領収書の作成依頼メッセージが同時に発生しても、メッセージを保存できることを意味している。

## SQSをLambdaに連結した場合のエラーハンドリング

Amazon SQSとAWS Lambdaを連携する場合、基本的にはAWS Lambdaの処理が正常終了したときにAmazonSQSキューから該当するメッセージが消えるしくみになっている。  
逆に、AWS Lambdaの処理が異常終了した場合はどうなるのでしょうか。AWS Lambdaによって「他のクライアントから取得できない状態」にされた（受信ハンドルを取得したと言い換えることもできます）メッセージはそのままになってしまいます。  
しかし、**可視性タイムアウト**という設定があるため、その秒数が経過した場合はメッセージの処理に何かしらの異常が発生したと判断し、自動的に「他のクライアントから取得できない状態」が解除されます。  
言い換えると、異常終了になった場合は、AmazonSQSキューのメッセージ保管期間に達するまで前述の状態と解除を何度も繰り返すことになるため、開発者はAmazonSQS固有の障害対応をする必要はなく、なるべく早くプログラムを修正しAWSLambda関数をデプロイするだけです。

## DLQ(Dead Letter Queue)

Amazon SQSキューのメッセージが指定回数処理されたらDLQとして使う別のAmazon SQSキューにメッセージを移動できる機能。  
名前にDead Letterとあるとおり、誤ったメッセージを溜めておく「退避キュー」のようなイメージ

## 冪等性の考慮

何らかしらのミスでキューに同じメッセージが2つ溜まってしまい、後続のメッセージに2つ渡されることがある。  
そのためアプリケーション側で担保を取らないといけない。何らかのIDなどを付与してあげる。
