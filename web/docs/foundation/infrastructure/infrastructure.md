# infrastructure

インフラ関連のためのディレクトリ

---

仮想化とコンテナーの違い

大前提
**ipアドレス127.0.0.1(localhost)はは仮想環境外部からはアクセスできない。**

## 仮想化

## コンテナー

ホストOS →（コンテナーで区切られた）プロセス  
コンテナーはコンテナー内のプロセスやライブラリを通してホストのOSのカーネルを使っている

## エンタープライズアプリ

エンタープライズアプリとは、サーバ・DB・ネットワーク機器などを組み合わせて作られた、1つの大きなシステム
**会社内で使われる業務システムや、LAMP(Linux/Apache/MySQL/PHP)などの比較的古い技術で作られたwebアプリなどが当てはまる**

## サーバーレスアプリ

**アプリを動作させるインフラをAWSの機能ですべて管理する仕組みのこと。**
サーバを安定させて稼働させたり、急な負荷に対する性能を向上させたりすることが自動で行われる。
**このようなシステムは、大人気アーティストのライブチケット販売や、選挙期間中の期間限定サイトなど、短期間で大量のユーザに利用してもらうようなサービスを構築するときに使われる。**

## アプリケーションサーバーの前にWebサーバ(Apache or Nginx)を置く理由

[stack overflow](https://ja.stackoverflow.com/questions/19405/django-%E3%81%AE%E4%B8%8B%E3%81%AB-apache-%E3%82%84-nginx-%E3%81%8C%E5%BF%85%E8%A6%81%E3%81%AA%E3%81%AE%E3%81%AF%E3%81%AA%E3%81%9C%E3%81%A7%E3%81%99%E3%81%8B)

Djangoなどのフレームワークなどはhttps接続が可能だが、一般的にはアプリケーションサーバを直接公開せずApacheやnginxなどのWebサーバを介して公開する。
これは**アプリケーションサーバではCPU・メモリ効率が悪い**ため、画像・スタイルシート・スクリプトファイルなどの静的なファイル高速はWebサーバ（nginx or Apache）に任せるため、というのが大きな理由。
その他、アクセス制御などのインフラ周りの処理はアプリケーション側ではなくWebサーバに持たせたい、複数のアプリケーションサーバを利用する場合にも柔軟に対応できる、Webサーバが持つ高機能な仕組みを利用したい（アプリケーションサーバはWebサーバとして低機能なことが多い）などの理由もある。

## Webサーバとアプリケーションサーバ

[参考URL](https://qiita.com/takahiro1127/items/fcb81753eaf381b4b33c)

### webサーバーとは

HTTPに則り、HTMLや画像の情報を返してくれるもの、イメージ的には静的なwebサイトで提供されるもの（HTML,CSS,JavaScriptなど）が、このwebサーバーで返されるイメージ。

### アプリケーションサーバーとは

アプリケーションサーバーは送られてきたリクエストに対して、rubyやphpなどを実行して、動的な処理をした結果を静的な要素に変換してwebサーバーに返すためのもの。つまり、動的なサイトを動かす上で必要なもののうち、静的ではない部分を作ってくれるもののイメージ。

よって、静的な要素のみで作っているサイトだったら、内部的にdbをいじったりそれに合わせた処理をしてhtmlを作ったりする必要がないので、webサーバーのみで大丈夫。

## localhostを公開する(ngrok)

[ngrok](https://hirooooo-lab.com/development/https-for-localhost/)

## ドメイン切り替え手順

1 Parrot本番用アカウントにホストゾーン（www.nijisanji.jp）を作成する。  済
2 "Peacock用アカウントのホストゾーン（www.nijisanji.jp）から、Parrot本番用アカウントに作成したホストゾーンに、
NSレコードとSOAレコード以外のレコードをコピーする。"  済
3 大元アカウントのホストゾーン（nijisanji.jp）からParrot本番用アカウントのホストゾーンに権限を委譲する。 "ns-1285.awsdns-32.org.
ns-638.awsdns-15.net.
ns-1556.awsdns-02.co.uk.
ns-188.awsdns-23.com." 済
4 Parrot本番用アカウントのus-east-1リージョンでSSL証明書を作成する。 <www.nijisanji.jp> 済
5 ParrotフロントエンドのディストリビューションのCNAMEをワイルドカード形式に変更し、SSL証明書を設定する。 *.nijisanji.jp 済
6 Parrot本番用アカウントのホストゾーンのALIASレコードの値をParrotフロントエンドのドメイン名に変更する。 d31a565p7tmfip.cloudfront.net 済
7 PeacockアカウントのホストゾーンのALIASレコードの値をParrotフロントエンドのドメイン名に変更する。 d31a565p7tmfip.cloudfront.net 済
8 PeacockフロントエンドのディストリビューションのCNAMEをブランクに変更する。  済
9 ParrotフロントエンドのディストリビューションのCNAMEを非ワイルドカード形式に変更する。 <www.nijisanji.jp> 済
   
 切り戻し手順  
10 PeacockフロントエンドのディストリビューションのCNAMEをワイルドカード形式に変更する。 *.nijisanji.jp 
11 大元アカウントのホストゾーン（nijisanji.jp）からPeacock用アカウントのホストゾーンに権限を委譲する。  
12 Parrot本番用アカウントのホストゾーンのALIASレコードの値をPeacockフロントエンドのドメイン名に変更する。 d1mo6gg8g3fke7.cloudfront.net 
13 PeacockアカウントのホストゾーンのALIASレコードの値をPeacockフロントエンドのドメイン名に変更する。 d1mo6gg8g3fke7.cloudfront.net 
14 ParrotフロントエンドのディストリビューションのCNAMEをブランクに変更する。  
15 PeacockフロントエンドのディストリビューションのCNAMEを非ワイルドカード形式に変更する。 <www.nijisanji.jp> 
