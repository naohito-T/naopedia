# cache まとめ

[素晴らしいblog](https://blog.yuuk.io/entry/2019/survey-coordinated-caching?amp=1)

## キャッシュ制御が重要な理由

ブラウザーキャッシングは、リソースを保存してインターネット上のユーザー体験を向上させる優れた方法ですが、キャッシュを制御しないと、非常に脆化する恐れがある。
すべてのサイトのすべてのリソースは、同じキャッシュルールに制約されています。
つまり、機密情報は公開情報と同じ方法でキャッシュされ、頻繁に更新されるリソースは、めったに変更されないリソースと同じ期間だけキャッシュされます。

## cacheの種類

[キャッシュに関しては最高](https://michimani.net/post/developCDNent-cache-strategies-for-hugo/)

静的サイトだけでなくWebサイトに対するキャッシュとしては、大きく分けて下記の二種類のキャッシュがある。

- サーバサイド
CDNキャッシュ
データベースキャッシュ
※注意点
CDNのキャッシュは管理者（サイト運営者）側で削除することができる。

- クライアントサイド
cookie
ブラウザのローカルキャッシュ
※注意点
CDNのキャッシュは管理者（サイト運営者）側で削除することができるが、ブラウザのローカルキャッシュは削除できない。
ブラウザのローカルキャッシュはサイトを閲覧しているユーザの端末に保存されるキャッシュなので、ブラウザのスーパーリロードを実施してもらったり、その他の方法でキャッシュを削除してもらうようユーザに依頼する必要があります。


## ブラウザローカルキャッシュさせない

ブラウザのローカルキャッシュを保存させないようにするためには、レスポンスヘッダーに`Cache-Control`でキャッシュの動作を指定する必要がある。

## cacheするコンテンツ・データの種類

キャッシュするコンテンツ・データにも下記のような種類がある。
- html
- css, js
- 画像データ
それぞれキャッシュが残っていることで古い情報が表示され続けていたり、表示が崩れていたり、ボタンなどの動作が正しくなかったりといったことが起こる。
場合によってはコンテンツ・データの種類によってキャッシュ戦略を変える必要も出てきます。

---

[参考URL](https://www.cloudflare.com/ja-jp/learning/cdn/glossary/what-is-cache-control/)

## Cache-Controlとは

[参考URL](https://www.cloudflare.com/ja-jp/learning/cdn/glossary/what-is-cache-control/)

Cache-Controlは、**ブラウザーのキャッシュ動作を管理する**HTTPヘッダーのこと。
簡単に言えば、誰かがWebサイトを訪問するとブラウザーはキャッシュと呼ばれるストアに画像やWebサイトデータといった特定のリソースを保存します。
そのユーザーが同じWebサイトを再度訪問すると、Cache-Controlは、そのユーザーにローカルキャッシュからリソースを読み込ませるか、またはブラウザーがサーバーに新しいリソースを要求する必要があるかを決めるルールを設定します。Cache-Controlをより深く理解するには、ブラウザキャッシュおよびHTTPヘッダーの基本を理解する必要があります。

cache-control: max-age
このディレクティブは、ダウンロード後にキャッシュからリソースを提供できる秒数、つまり寿命を指示する。
たとえば、最大寿命が1800に設定されている場合、リソースをサーバーへ最初に要求してから1,800秒（30分）


## ブラウザーキャッシュ

ブラウザーキャッシュは、WebブラウザーがWebサイトのリソースを保存することでサーバーから再度取得しなくても済むようにするもの。
たとえば、Webサイトの背景画像はキャッシュとしてローカル保存されるため、ユーザーがそのページを再度訪問したときに、画像はユーザーのローカルファイルから読み込まれるのでページ読み込み速度はずっと速くなる。

そうしたリソースをブラウザーはTime To Live（TTL）と呼ばれる一定期間だけ保存します。
ユーザーがTTLの期限が切れた後でキャッシュされたリソースを要求した場合、ブラウザーはサーバーに再度アクセスしてリソースの新しいコピーをダウンロードしなければならない。
ブラウザーとWebサーバーは、各リソースのTTLをどのように見分けるのでしょうか？ここで登場するのがHTTPヘッダーです。

## HTTPヘッダーとは



## cacheの重要性

Webサービスの応答速度を向上させることにより、ユーザー体験向上につながる。
実際に40%以上のWebサービスのユーザーは**ページの読み込みを3秒以上待てない**という調査結果がある。

クラウドコンピューティングを利用し、Webサービスを提供する場合の読み込み遅延の要因は次の3つ。
1. クラウドのデータセンター内での処理遅延
2. エンドユーザーとデータセンター間のネットワーク転送遅延
3. ブラウザ上でのコンテンツ表示遅延

## 過去のcache

Webサービスを提供する企業は、Akamai・CloudFrontなどの事業者が提供するCDN(Content Delivery Network)を以前より活用し、**画像や動画などの静的コンテンツの配信を高速化**してきた。

## 最近のcache

近年では、一度キャッシュされたデータを破棄するまでの処理時間が高速化したことにより**動的コンテンツのキャッシュにもCDNを利用することがある。**
さらには、単なるキャッシュを配信するだけでなく、**CDNのエッジサーバ上**で要求に対して任意の処理を実行できるように、エッジサーバに任意のアプリケーションを配置することが可能となる**CDN Edge Workerと呼ばれるサービス**が登場している。

プログラミング言語処理系の制約があるものの、CDN Edge Workerとしては、AWS Lambda@Edge2・Cloudflare Workers3・fly.io4などがある。

## 動的コンテンツに対するCDN

すべてのエッジでキャッシュが無効化されるまでに遅延があり、キャッシュ間またはキャッシュとオリジンの**データ間の一貫性が弱い**という課題がある。
CDN Edge Workerにおいてもアプリケーションの配置は可能であるが、データの一貫性については厳密に保証するデータストアが提供されているわけではない。

## エッジコンピューティング

CDN以外にも、**エンドユーザーとクラウドのデータセンターの間に中間層**を設けることにより、ネットワークレイテンシを最小化するエッジコンピューティングが研究されている。
エッジコンピューティングの研究分野では、IoT (Internet of Things)。スマートシティ、仮想現実などの従来のPCやスマートフォン以外のエンドデバイスを活用するような新しいコンピューティングへの適用が主目的となっている。

[エッジコンピューティング参考URL](https://memo.yuuk.io/entry/2019/learning-edge-computing01)

---

## 分散キャッシュの関連技術

**Webアプリケーションの読み出し性能を向上するためのキャッシュの要素技術**を整理し、その特徴を列挙する。
要素技術として、オブジェクトキャッシュ・クエリリザルトキャッシュ・HTTPキャッシュ・ICN(Information-Centric Networking)がある。

### オブジェクトキャッシュ

オブジェクトキャッシュは**アプリケーションが任意のオブジェクトをキャッシュ**するための機構。
オブジェクトキャッシュのためのデータストアとして、
1. アプリケーションプロセスが**ネットワーク通信して**利用するネットワーク型の分散キャッシュシステム
2. アプリケーションプロセスと**同一のメモリ空間に**キャッシュデータを保持する組み込み型の分散キャッシュシステム


- ネットワーク型の分散キャッシュシステム
`Memcached`や`Redis`が広く利用されている。
これらのキャッシュシステムを複数のキャッシュノードへ負荷分散するために、**ハッシュ法を利用することにより**オブジェクトのキーと分散先のキャッシュノードを紐付けし、オブジェクト単位で分散させてキャッシュノードへデータを配置する。
この手法は、キャッシュノードの追加または削除時にオブジェクトのキーとノードの紐づけが変更され、大部分のキーを再配置することにより性能が低下するという課題をもつ。
そこで、ノードの追加・削除時にオブジェクトのキーとノードの割り当てをなるべくかえずに、分散するためにコンシステントハッシュ法が利用される。


### クエリリザルトキャッシュ

[参考URL](https://blog.yuuk.io/entry/2019/survey-coordinated-caching?amp=1#fnref:7)
データベースミドルウェア層でキャッシュする場合、DBへの**クエリの結果をキャッシュ**するクエリリザルトキャッシュを利用する。
MySQLのクエリリザルトキャッシュは、**DBサーバ自体がキャッシュ機構をもつため追加のソフトウェアなしに**クエリリザルトキャッシュを利用できる。
テーブルに更新があれば当該テーブルの変更が結果に影響するクエリのキャッシュを破棄するため、テーブルとキャッシュ間で一貫性を維持する

## 静的サイトのキャッシュ戦略

静的サイトでは、その名の通りデプロイ時以外にコンテンツ情報が更新されることはないため、できる限りキャッシュの恩恵を受けることが望ましい。
そのため、基本戦略としてCDN/ブラウザともにキャッシュ時間は長くしておくのがよい。

## ブラウザからキャッシュヒットしているか確認する(Chrome)

CloudFront利用時に、キャッシュヒットしているか/どのくらいの時間キャッシュされているかを確認する

- キャッシュの確認をするときに確認するHTTPヘッダー
x-cache
age

**x-cache**
キャッシュヒットしたかどうかを判断できる。

**age**
キャッシュされてからの経過時間。

- キャッシュの設定で利用するHTTPヘッダー
Cache-Control
Expires

**Expires**
レスポンスヘッダーにのみ設定される。
キャッシュをいつまで有効とみなすか日時を指定する。



検証確認

