# CSRF (クロスサイト・リクエスト・フォージェリ)
[めちゃくちゃ参考になる](https://www.trendmicro.com/ja_jp/security-intelligence/research-reports/threat-solution/csrf.html#:~:text=%E3%80%8C%E3%82%AF%E3%83%AD%E3%82%B9%E3%82%B5%E3%82%A4%E3%83%88%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%83%95%E3%82%A9%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%AA,%E6%94%BB%E6%92%83%E6%96%B9%E6%B3%95%E3%81%AE%E3%81%93%E3%81%A8%E3%81%A7%E3%81%99%E3%80%82)

クロスサイトリクエストフォージェリ（CSRF）とは、Webアプリケーションに存在する脆弱性、もしくはその脆弱性を利用した攻撃方法のこと。  
掲示板や問い合わせフォームなどを処理するWebアプリケーションが、本来拒否すべき他サイトからのリクエストを受信し処理してしまう。

例
サービスの利用者を罠サイトにアクセスさせて、APIサーバーに対する意図しないリクエストを送信させること。  
そのユーザーがサービスにログイン済みであり、セッションIDをクッキーに保存していた場合、その情報も一緒に送信される。  
そのため、そのリクエストは「認証済みのユーザーからのリクエスト」であるため、ユーザーが意図していなかったとしても、そのリクエストは正当なリクエストとして処理されてしまう。  
これにより、退会や決済、SNSへの不適切な投稿などのセンシティブな操作が、ユーザーが意図しない形で行われてしまう。

## 攻撃の手法・特徴

- 攻撃者は攻撃用Webページを準備し、ユーザがアクセスするよう誘導する。
- ユーザが攻撃用Webページにアクセスすると、攻撃用Webページ内にあらかじめ用意されていた不正なリクエストが攻撃対象サーバに送られる。  
- 攻撃対象サーバ上のWebアプリケーションは不正なリクエストを処理し、ユーザが意図していない処理が行われてしまいます

<!-- ## プリフライトリクエストをCSRFとして用いるのは適切ではない -->

## 対策(CSRFトークン)

CSRF対策としてよく利用されるのがトークンを用いた対策。  
SPAでは難しく、SPAをレンダリングするサーバーとAPIサーバーが別々の場合、

たとえばRailsアプリの場合は、Railsが返すhtmlのなかにトークンを仕込んでおき、それを`document.getElementsByName('csrf-token')[0].content`のような形で拾って、それをAPIへのリクエストの際に送信すればよい。  
だが一般的なSPAではフロントエンドとバックエンドが独立して存在していると思うので、この方法は使えない

ここで**CORS**が絡んでくる。

SPAでAPIを叩く場合は、`form`ではなく`XMLHttpRequests`や`fetch`を用いて非同期通信で叩くことになるのが一般的だと思うが、異なるオリジンに対して非同期通信を行うときは必ず、CORSを用いた通信になる。  
このCORSの仕組みが、「トークンを使わない場合のCSRF対策」の根幹になる。

上述したように、「異なるオリジン間の非同期通信」は必ずCORSを利用した通信になるので、CORSの仕組みを利用してCSRF対策を行っていく。








