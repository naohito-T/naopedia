# security

セキュリティ関連について記す

## 認証

認証は「あなたは誰ですか？」を確認すること。  
要はパスワード認証で本人を特定すること。  
2段階認証などもある。

### SMS認証
[参考URL](https://www.aspicjapan.org/asu/article/4367)

SMS認証とは、ユーザーのスマホや携帯電話にSMS（ショートメッセージ）を送信し、そこに記載された一時的な確認コードをWeb上で入力することで、本人確認を正しく行う認証システム。

企業側の動作
ユーザーからSMS認証の要求を受けたら、API経由でSMS送信サービスに送信を要求する。  
SMS送信サービスが認証コードを記載したSMSをユーザーに送信  
Web上で認証コードが入力されると、API経由でSMS送信サービスから企業側に送達結果が通知される。  
正しいことが確認されたら認証完了  
SMS送信サービスで認証を行うためには、自社システムとのAPI連携が必須。  
サービスによってAPI連携の仕様が異なるため、連携可能かどうか確認しておく必要がある。  

## 認可とは

一方、認可は「あなたには、リソースにアクセスする権限がありますか？」を確認すること。  

たとえば次のような事例が認可。  
家の鍵を持っているから、家に入ることができる
バスの乗車券を持っているから、バスに乗ることができる  

## 認証と認可の違い

**わかりやすい**
パスポートは本人確認に用いられつつ（認証）、これにより渡航する権利を得られる（認可）
免許証は本人確認に用いられつつ（認証）、これにより自動車を運転する権利を得られる（認可）

## WAF(Web Application Firewall)

[参考URL](https://www.infraexpert.com/study/security17.html)
[参考URL](https://dev.classmethod.jp/articles/fully-understood-aws-waf-v2/)

従来の**ファイアウォールやIDS/IPSでは防ぐことができない不正な攻撃からWebアプリケーションを防御するファイアウォール**のこと。
Webアプリケーションという観点から一般的にはWAFといえばWebサーバが利用するポート80番・443番のトラフィックを双方向で監視して悪意あるユーザからWebアプリケーションとその背後にあるデータを守る製品のこと。

※一般的なWebアプリケーションに対する攻撃手段としてSQLインジェクションやXSS（クロスサイトスクリプティング）などの脅威から保護する。

![WAF](images/waf.png)

## ReDoS

[ReDos](https://yamory.io/blog/about-redos-attack/)

---

## CORS(Cross-Origin Resource Sharing) : クロスオリジンソースシェアリング
[リファレンス](https://develwoper.mozilla.org/ja/docs/Glossary/CORS)  
[参考URL](https://qiita.com/ryosuketter/items/a60a2bc0220a5cbff17e)  
[仕組みが書いてある](https://www.twilio.com/blog/add-cors-support-express-typescript-api-jp)

オリジン間リソース共有（CORS）とは、最新ブラウザに装備されている**セキュリティプロトコル。**
HTTPリクエストを開始したオリジンに応じて、異なるオリジンで共有するリソースの許可、制限を行う。
>フロントエンドの JavaScript コードがアクセスすることをブロックするかどうかを決めるものです。


```
https://www.twilio.com
  ^       ^
  |       |
scheme hostname

http://localhost:5000
  ^       ^       ^
  |       |       |
scheme hostname  port
```

### CORSがなかった時代

CORSがなかった時代は**同一オリジンのみ通信ができた**

## Preflight request (プリフライトリクエスト)
[リファレンス](https://developer.mozilla.org/ja/docs/Glossary/Preflight_request#:~:text=CORS%20%E3%81%AE%E3%83%97%E3%83%AA%E3%83%95%E3%83%A9%E3%82%A4%E3%83%88%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88,%E3%81%97%E3%81%A6%E3%83%81%E3%82%A7%E3%83%83%E3%82%AF%E3%81%97%E3%81%BE%E3%81%99%E3%80%82)



## ブラウザの仕組み

ブラウザは**すべてのリクエストにOriginヘッダーを追加する。**  
リクエストがサーバーに届くと、リクエストのオリジンがリソース取得許可リストに含まれている場合に、サーバーが`Access-Control-Allow-Origin`ヘッダーをレスポンスに追加する。
この情報からブラウザはコンテンツがこのオリジンにアクセスできると判断する。

### 同一オリジンポリシー
[リファレンス](https://developer.mozilla.org/ja/docs/Web/Security/Same-origin_policy)

同一オリジンポリシーは重要なセキュリティの仕組みであり、あるオリジンによって読み込まれた文書やスクリプトが、他のオリジンにあるリソースにアクセスできる方法を制限するもの。

### オリジンの定義

2つのページのプロトコル、ポート番号（もしあれば）ホストが等しい場合、両者のページは同じオリジンとみなす。


---

## 符号・暗号化・ハッシュの違い

[参考URL](https://ja.spot-the-difference.info/difference-between-encryption)

**暗号化、エンコード、およびハッシュは、データのフォーマットを変換するために使用される技法**

---

## ハッシュ
[参考URL](https://medium-company.com/bcrypt/)

データを加工する技術のひとつ
**ハッシュ値とは、あるデータを暗号学的ハッシュ関数と呼ばれる方式で変換したもの。**

仕様
- ハッシュ値から元のデータを復元することはできない。
- また異なる2つのデータから作ったハッシュ値同士が同じ値になる可能性は極めてひくい

dbにパスワードが保存される時によく使われる（平文で保存はだめ）
[dbに平文を保存してはいけない理由](https://medium-company.com/bcrypt/)

- ハッシュのアタック方法
[参考URL](https://www.wakuwakubank.com/posts/739-node-crypto/)

レインボーテーブル攻撃対策
ソルト（Salt）の使用  
パスワードごとに別々のソルトを用意して、同じパスワードでもハッシュ値が異なるようにする。

オフライン総当たり攻撃対策
ストレッチング（ハッシュ関数を繰り返して実行）によって、ハッシュ化の処理を意図的に遅くする。  
ただし、パスワード認証の時間が長くなるというトレードオフがある。

### ソルト

ソルトとは、パスワードをハッシュ値へと変更する際にパスワードへ付与するランダムな文字列のこと。

### ストレッチング

ストレッチングとは、ハッシュ関数を用いてハッシュ値への計算を数千回～数万回繰り返し行うことです。

---


## IPA 

[旧版](https://www.ipa.go.jp/security/awareness/vendor/programmingv1/a01_04.html)
[新版]()

---

## プログラマの暗号化入門

[参考URL](https://qiita.com/asksaito/items/1793b8d8b3069b0b8d68)

暗号化の対語は復号

登場人物を理解することが大切。

**暗号化の登場人物**
入力として、平文、鍵、初期ベクトル、暗号モードを渡すと、
出力として、暗号文ができ上がる。

**復号化の登場人物**
入力として、暗号文、鍵、初期ベクトル、暗号モードを渡すと、
出力として、平文ができあがる。


## 用語

平文（ひらぶん）
暗号化されていない元のデータのこと（英語ではplain text）

暗号文
何らかの暗号アルゴリズムで秘匿化されたデータ（英語ではcipher text）

鍵
平文を暗号文にする際、使用するデータのこと（英語ではkey）

初期ベクトル
同じ平文が同じ暗号文にならないように使用するデータのこと（英語ではinitial vector、もしくはIV）
平文中に同じデータが繰り返し出てきた場合に、すべてが同じ暗号文に変換されてしまうと、その頻度などから平文が推測されやすくなってしまう。
そのため強度的に不安な部分を初期ベクトルを使って同じ暗号文にならないようする。
**初期ベクトルは鍵と違って他人に知られても問題ないもの**

暗号モード
初期ベクトルをどのように使用するか決めるモードのこと。（英語では、cipher mode）
初期ベクトルの利用方法はいくつかの種類があります。（ECB、CBCモードなど）

パディング
暗号アルゴリズムにもよりますが、暗号化をするにあたって、平文のデータ長は何らかの倍数長でなければなりません。（たとえば16byteの倍数長）
平文が倍数長になっていない場合に、平文にムダなデータ（詰め物）を付加することをパディングすると言います。
パディングデータは復号時には除去されます。

## 暗号化は2種類ある

**逆にいうと2つしかない。**

1. 共通鍵暗号
暗号鍵と復号鍵が同じ鍵なので共通鍵暗号と言われる。
**家の玄関の鍵と同じ仕組み。**
後述する公開鍵暗号に比べて、暗号化の処理速度が速いという特徴がある。


2. 公開鍵暗号

## Digest認証(ダイジェスト認証)

HTTPの認証方法のひとつ。
ユーザ名とパスワードを暗号学的ハッシュ関数でハッシュ化して送る。
**Basic認証では防げなかった盗聴や改ざんを防ぐために考案された**
使用する暗号学的ハッシュ関数としては、当初MD5が規定され、後にRFC7616でSHA-2が加わっている。

## UUID ULID

[違いの参考URL]()

Tips
[Facebook, Twitter, Instagramなどがどうやって生成しているか](https://qiita.com/daisy1754/items/98a6e6b17d8161eab081)

ULID（Universally Unique Lexicographically Sortable Identifier）はUUIDを改良したもので、UUIDと同じ128ビットでありながら、UUIDは**36文字**ですが、ULIDは**26文字**で表される。
[ULIDジェネレーター](https://ulidgenerator.com/)

## チェックサム(checksum)

[参考URL](https://wa3.i-3-i.info/word1240.html)

その**送られてきたデータは途中でおかしくなっていないか**をチェックする方法のひとつ。
ruby gemsとかはチェックサムが表記されているためダウンロードした際に、データがおかしくないか確認できる。

## サニタイズ(sanitize) / サニタイジング(sanitizing)

[参考URL](https://ssaits.jp/promapedia/technology/sanitize.htmlc)
[処理参考](https://qiita.com/tnemotox/items/b4b8f0f627e23dd62447)
サニタイジングとは**利用者が入力した文字データを受け取る際**に、プログラムにとって特別な意味を持つ可能性のある文字や文字列を検知して、一定の規則にしたがって別の表記に置き換えること。
これはクロスサイトスクリプティングを防ぐことになる。

---

## CSRF(クロスサイトリクエストフォージェリ)
[参考URL](https://www.trendmicro.com/ja_jp/security-intelligence/research-reports/threat-solution/csrf.html)

Cookieを悪用したセキュリティ攻撃のひとつ
この攻撃では、ドメインが異なるサイト間でCookieを悪用して本来意図しないサイトに対して書き込みをしてしまったり、意図せず退会処理をしてしまったりします。
今までは各サイト側でCSRFに対しての対策を各自が施す形でしたが、これをブラウザレベルでしっかりと防御しようという意図があるのが今回のSameSiteの仕様変更となります。

### 対策

ALBでは
リクエストする際にランダムな数字をURLに付与する。
サーバからのレスポンスでsession storageに保存したランダムな数字で検証する。
→ネットワーク越しに改ざんなどされていないことを確認する。



---

## セッションハイジャック

## SQL インジェクション

## XSS
 
## クリックジャッキング

## Webhookとセキュリティー
[参考URL](https://qiita.com/en30/items/6a5dfae217c1f9ebc2dd)

## SPAセキュリティ
[わかりやすい](https://www.slideshare.net/ockeghem/phpconf2021spasecurity)

SPAでもセキュリティの基本は同じ

- フロント側（JS）
クロスサイトスクリプティング
オープンリダイレクト
evalインジェクション

- サーバー側（API)
SQLインジェクション
クロスサイトスクリプティング（反射型、持続型）
クロスサイトリクエストフォージェリ（CSRF）


## 暗号鍵の管理
[参考URL](https://www.ogis-ri.co.jp/otc/hiroba/technical/security/operation-cryptographic-key.html)

暗号鍵を利用すると主に次の2つのことが実現できる。  
- 情報資産を第三者へ読み取られないようにする【暗号化】
- 情報資産が改ざんされていないかどうかを確認する【改ざん防止】

## パスワードポリシー
[パスワードポリシーとは](https://www.cyclonis.com/ja/what-is-password-policy-how-to-create-good-one/)

## パスワードローテーション

従業員に定期的にパスワードの変更を強制する