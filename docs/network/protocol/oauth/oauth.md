# OAuth
[一番分かりやすい OAuth の説明](https://qiita.com/TakahikoKawasaki/items/e37caf50776e00e733be)
[passportの説明](https://www.passportjs.org/concepts/oauth2/?utm_source=github&utm_medium=referral&utm_campaign=passport-google-oauth20&utm_content=nav-concept)

OAuthはプロトコルのひとつ。

OAuth = 認可（権限の認可:行動やリソースの許可をすること）
**権限の認可を行う**オープンスタンダードライブラリ。
まず、前提知識として、OAuthという『アクセストークンを発行する仕組み』がある。
アクセストークンは、アプリケーションをAPI経由で操作するときなんかに使われる。
例としてTwitterクライアントを自作するときにアクセストークンを使ったりします。

**このOAuthは前述のとおりアクセストークンを発行する仕組みであって、認証については定められていません。認証に必要な、ユーザー情報などの取得については決まっていない。**

このOAuthを拡張し、ユーザー情報の取得についてなどを標準化したのがOpenID Connectが策定された。

## OAuthにとってのGoogleやFacebook
[参考URL](https://www.passportjs.org/concepts/oauth2/terminology/)

OAuth 2.0の用語では、Facebookは承認サーバー(AS) です。
認可サーバーの目的は、ユーザーを認証して認可を取得することです。承認は通常、ユーザーに同意を求めるプロンプトによって取得されます。承認が取得されると、承認サーバーはアプリケーションにアクセス トークンを発行します。



## OAuthがないと

OAuthは、第三者となるアプリケーションに対して安全にアクセス権限を提供するためのプロトコル。
たとえば、GitHubのAPIを利用するアプリケーションAをOAuthなしで使うとすると、通常はGitHubのユーザIDとパスワードをアプリケーションAに預ける必要がある。

この手法ではパスワード漏洩の危険が増しますし、アプリケーションAはGitHubに対してユーザと同じ権限を持つことになってしまう。
アプリケーションAの運営者がその気になれば、ユーザをGitHubから退会させることもできるでしょう。
OAuthを利用すると、パスワードをアプリケーションAに渡さずともよくなります。さらに、アプリケーションAがその機能を提供するのに必要な権限だけを与えることができる、


## OpenID Connect

>OAuth 2.0を使ってID連携をする際に、OAuth 2.0では標準化されていない機能で、かつID連携には共通して必要となる機能を標準化した』OAuth 2.0の拡張仕様のひとつである

- OpenID Connectによる認証のフロー
このOpenID Connectは広く使われている認証方法のためフローを押さえておく。
**まずIDトークンというユーザ情報が含まれたアクセストークンがあり、これを次のフローでやりとりする。**

| 順番  | リクエスト元 | 相手     | 内容                       |
| --- | ------ | ------ | ------------------------ |
| 1   | クライアント | プロバイダー | IDトークンを要求する              |
| 2   | プロバイダー | ユーザ    | IDトークンの発行可否を聞く。あわせて認証を行う |
| 3   | ユーザ    | プロバイダー | 発行可否と、発行する場合に認証情報を送る     |
| 4   | プロバイダー | クライアント | IDトークンを発行する              |

※この１と４のやりとりを標準化したのがOpenID Connect
OAuthが『アクセストークンを発行する仕組み』なのに対して、OpenID Connectはこれを拡張して『IDトークンを発行する仕組み』と考えるとわかりやすいかもしれません。

>詳しいことはさておき、『Googleなどのアカウント認証を使う』=『OpenID Connectを使う』という認識がもてればいいのかな、と思います。

>Googleの認証方法はOpenID Connectではない
>OpenID Connectについて書きましたが、実際のところGoogleやTwitterの認証はOpenID Connectではありません。GoogleはOpenID Connectの仕様に準拠しつつ、OAuth 2.0を採用しています。TwitterはOAuth 1.0aという仕様で、OpenID Connectには準拠していません。
>いずれにしてもOAuthをベースにした認証を行なっていますが、ここではわかりやすさのためにOpenID Connectという用語に統一して説明しています。


## SMS認証
[参考URL](https://www.aspicjapan.org/asu/article/4367)

SMS認証とは、ユーザーのスマホや携帯電話にSMS（ショートメッセージ）を送信し、そこに記載された一時的な確認コードをWeb上で入力することで、本人確認を正しく行う認証システム。

企業側の動作
ユーザーからSMS認証の要求を受けたら、API経由でSMS送信サービスに送信を要求する
SMS送信サービスが認証コードを記載したSMSをユーザーに送信
Web上で認証コードが入力されると、API経由でSMS送信サービスから企業側に送達結果が通知される
正しいことが確認されたら認証完了
SMS送信サービスで認証を行うためには、自社システムとのAPI連携が必須です。サービスによってAPI連携の仕様が異なるため、連携可能かどうか確認しておく必要があります。

## OAuth flow

[参考URL](https://qiita.com/TakahikoKawasaki/items/200951e5b5929f840a1f)
[これ実装するのにいいかもしれない。](https://qiita.com/TakahikoKawasaki/items/e508a14ed960347cff11)

## 認証と認可の違い
[参考URL](https://zenn.dev/tanaka_takeru/articles/aecd36a805886d)

先に結論を述べると、認証と認可は何を確認しているかという点で違いがあります。

認証
「あなたは誰ですか？」を確認
認可
「あなたには、リソースにアクセスする権限がありますか？」を確認

英語と省略表記について
認証と認可、同じような日本語ですが、実は英語も似ています。

認証：Authentication、AuthC や AuthN と略されることも
認可：Authorization、AuthZ と略されることも



## 認証

認証は「あなたは誰ですか？」を確認すること。
たとえば、次に挙げたものを確認することが認証です。

What you are：相手自身の特徴を確認
例）指紋認証や顔認証
What you have：相手が持っているものを確認
例）免許証やパスポート
What you know：相手が知っていることを確認
例）emailとpassword

## 認可とは

一方、認可は「あなたには、リソースにアクセスする権限がありますか？」を確認することです。
たとえば次のような事例が認可です。

家の鍵を持っているから、家に入ることができる
バスの乗車券を持っているから、バスに乗ることができる

## 認証と認可の違い

認可で例示した「家の鍵を持っているから、家に入ることができる」ケースを考えると、認証と認可が異なる概念であることが分かります。
その人は、家の鍵を持っていたので家に入ることができた（認可された）
しかし、その鍵は奪ったものかもしれないし、一時的に借りたものかもしれない。
つまり、鍵を持っていたからといって、その家の住人であるとは限らない（認証はされていない）

一方、次のようなケースでは認証と認可を同時に行っています。

**わかりやすい**
パスポートは本人確認に用いられつつ（認証）、これにより渡航する権利を得られる（認可）
免許証は本人確認に用いられつつ（認証）、これにより自動車を運転する権利を得られる（認可）