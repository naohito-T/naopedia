# Makefile

Makefileはプロジェクトでよく使用されるタスクランナー
JSを使用する場合はpackage.jsonを使う`npm run`

[参考URL](http://masahir0y.blogspot.com/2012/02/linuxmakefile-4.html)
[Makefile ことはじめ](https://qiita.com/kasei-san/items/ad25df63260e86c5cc71)

LinuxカーネルのMakefileで多様されている

## 前提

Makeを理解するには**コンパイルへの理解が重要。**

## Makefile 基本

主にMakefileはmakeにプログラムのコンパイル及びリンク方法を指示する。
Makefileに含まれる情報は主に3つ。

- 変数の定義(変数、自動変数、暗黙の変数、特殊変数)
- ルール
- その他(他のMakefileをoverrideするときの情報やデバッグ情報など

## makeはどんな時に使うのか

makeはCのプログラムを生成するのに使われている
makeはそもそも複数のファイルが色々と依存して構成されているものをコンパイルするときに作業を軽減されるものとして開発された。
あるファイルが別のファイルに依存し、 そのファイルがまた別のファイルに依存しているような場合は、 正しい順番でそれらをコンパイルしなければならない。 また、元となるファイルのどれかひとつを修正したあとも、 コンパイルの順番を考えなくてはならない。make は このような作業を軽減する。
make は、ファイルの生成規則さえ正しく書いてあれば、 コンパイルの順番を自動的に決定する。make は 依存ファイルの更新日付を 調べ、ある依存ファイルを修正したときのコンパイル回数を 必要最小限に抑えるようにする。make はこれらの動作を行う際に、 生成規則を記した “Makefile”という 名前のファイルを参照する。
make が生成するのはふつう C のプログラムだが、べつに C のプログラムに限らず、Makefile に書く生成コマンドの書きように よっては、TeX のファイルだろうが、Java のプログラムだろうが 何でも make を利用して作業を軽減することができる。

## makeとは

makeはプログラムのビルド作業を自動化するツール
コンパイル・リンク・インストールなどのルールを記述したテキストファイル(Makefile)に従って、これらの作業を自動的に行う。
複雑に関連し合ったファイルの依存関係を解決するのが make の長所である。

## makefile実行

デフォルトはMakefileの一番上のターゲットのルールを実行する。

## 基本的なMakefileのフォーマット

ターゲット(作りたいファイル名): 依存ファイル, 依存ファイル...
  コマンド
  コマンド
  ...

## make実行

`make [ターゲット名]`

※`make`とだけ実行すると、Makefile内の一番最初のターゲットを実行する

```Makefile
clean:
    -rm a.out *.o	# 失敗しても make は中断しない

clean:
    @rm a.out *.o    # このコマンドを表示せずに実行

```

## 疑似ターゲット

ターゲットは基本的にターゲット名と同名のファイルを生成する処理
そのためmakeはターゲットと同名のファイルが既にあると(依存関係がある時以外は)処理を行なわない。

## PHONYターゲット

.PHONY ${ターゲット名} という記載で、そのターゲットは、ファイルは生成しないという事を make に知らせることができる

- ターゲットの概念が必要

ターゲットは、基本的にターゲット名と同名のファイルを生成する処理
なので、make は、ターゲットと同名のファイルが既にあると(依存関係がある時以外は)処理を行わない

```sh
$ touch clean
$ make clean
make: `clean' is up to date.
```

## Makefileでの変数展開

[参考URL](https://www.nooozui.com/entry/20200129/1580277274)

= の場合は都度参照(つまり new Dateすると時間が都度更新される)
:= の場合は1回のみの参照

```Makefile
# コマンド実行を変数に格納したい場合
FROM_DEPLOY_BRANCH := $$(git branch | head -n 1)
```

