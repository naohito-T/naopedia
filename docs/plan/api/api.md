# API

[参考URL](https://www.infoq.com/jp/articles/ballerina-fullstack-rest-api/?itm_source=infoq&itm_medium=related_content_link&itm_campaign=relatedContent_news_clk)

## API種類

フロントエンドから直接機能されるAPIの開発には、**いくつかの一般的な選択肢が存在する**

1. REST API
2. GraphQL API
3. WebSocket API

## 上記のAPI種類が決まったら

- セキュアな通信か
- 認証は？
- 承認は？
- 監視、可観測性、ログ

## Web API

Web APIを設計する際にさまざまなものを作成するかと思うがそれを記載する。

GET/POST

HTML4.0 `<form>`タグはmethod属性に追加できるのがGETとPOSTだけ。
初期のHTML5のドラフトではPUTやDELETEも使える仕様が盛り込まれたが、結局削除となった。

しかしapiがGETとPOSTにしか対応していないは使いにくい。
そういったケースにそなえ、よく利用されているケースはAPI側でGETとPOST以外のメソッドをPOSTを使って表現する方法が2つある。

どちらもメソッドとしてはPOSTを利用して、メタ情報として本当はこのメソッドが使いたいというふうにする

1. X-HTTP-Method-OverrideというHTTPリクエストヘッダーにDELETE or PUT入れる
こっちのが利用しやすい。

2. _methodパラメーター
railsで使用されている。

---

## Cookie

**Cookieはブラウザがパソコンのハードディスクに保存する小さなデータ**
Cookieとは、クライアント（ブラウザ）に保存される簡易なテキストファイルのこと。
サーバー（Rails）がクライアントに、一時的に情報を記録させるときに使用します。

httponlyオプション
httponlyは、HTTP通信でのみアクセスできるCookieを生成するためのオプションです。

このオプションを付けると、JavaScriptからのアクセスを完全に遮断することができ、サーバーサイドのRailsでしかアクセスできなくなります。
これにより、外部JavaScriptからのCookie盗聴を防ぎます。

- Cookieでも万全ではないことを理解しておく
Cookieへの保存は、外部からの攻撃を完全に遮断できるわけではありません。

JavaScriptで参照できるローカルストレージよりはマシなだけであって、Cookieのhttponlyオプションは、あくまで最低限のセキュリティだとお考えください。

**Cookieの法定タイムゾーンはGMT（グリニッジ標準時）と決められており、expiresはGMTで保存されます。**
**また、有効期限を判断するために使用されるタイムゾーンもGMTです。**
**GMTは日本時間マイナス9時間で、UTC（世界標準時）と一致します。**

## サブドメインでcookieを共有する

[参考URL](https://qiita.com/il-m-yamagishi/items/9aad5737c80d5bfd5eb8)

## クロスオリジン通信でのCookie共有設定

クロスオリジン通信でのCookie共有は双方に設定が必要。

**credentials（クレデンシャル）**
リクエストヘッダーのwithCredentials（ウィズ クレデンシャル）フラグをtrueにする。
withCredentialsは、クロスオリジンのクライアント資格情報を使用して、リクエストを行うことを許容するか否かを設定するフラグです。（デフォルトはfalse)

trueにすることで、
クロスオリジンリクエストの際に、Cookieを送信することができ、クロスオリジンレスポンスのCookieを受け取ることができます。

---

## Session セッション
[セッションのクッキーを設定する場合のベストプラクティス](https://blog.ohgaki.net/session-and-cookie)

セッションはCookieを使って実現するのが一般的
HTTPセッションは通常クッキーを利用して行います。クッキーを利用したセッションの場合、お薦めする設定は以下の通りです。

1. ドメイン名は指定しない

2. パスはルート（/）を指定する
パスですが、アプリの中にはURIパスを検出してパスを設定してクッキーを送るようにしている物もあります。ルート（/）とサブディレクトリ（/app1/など）にクッキーが設定されている場合、ルートの方が優先されるので安全面を考えるとルートの方が良いです。

3. セッション管理用のクッキーはセッションクッキー（有効期間0）にする
常識として知っておくべき知識です。クッキーの有効期限が0の場合、普通のブラウザは**クッキーをメモリにみ保存します。**
つまりブラウザを終了させるとクッキーが消えます。セッション管理には必ず有効期限0を指定すべきです。

4. httponly属性を付ける

5. 可能な場合は必ずsecure属性をつける

6. 複数アプリケーションを利用する場合はsession.nameまたはsession_name()でセッションクッキー名で指定する（アプリケーションの固有名デフォルトで設定し、設定項目として変更できるようにする）

## Session管理でやってはいけないこと

1. 有効期限の長いセッションを再ログイン用に使う
有効期限の長いセッションに良いことはない。
たとえば、公共のPCや友人のPCを使った時にブラウザを閉じてもまだログインした状態が続くのは良くありません。
自動ログインを有効にする場合は別の使い捨ての認証用クッキー（再認証用のトークン）を用い、ログインする場合に自動ログインするか、しないか選択できるようにしてユーザが制御できるようにします。ユーザが明示的にログオフした場合は再認証トークンも必ず無効にします。

2. Trans SIDを不要なのに有効にする
Trans SID(URLの書き換えによるセッション）を絶対に利用してはならない、とは言いませんが特別な理由がない限り有効にしてはなりません。ページやURLをメールなどで送信するとセッションIDが漏洩します。

最後にセッションIDは少なくとも定期的にsession_regenerate_id()で更新すべきです。ログインした時の更新は必須です。

## リクエストをparseする

列挙する
- クライアントからのjson parse（POSTのメッセージ部分）
- 通常のフォームリクエストのボディ（application/x-www-form-urlencoded）

### 通常のフォームリクエストのボディ

Content-Typeがapplication/x-www-form-urlencodedのケース
各フレームワークで違いはあれど、parseできる準備をしないといけない。


---

## JWT

[JWT=ステートレス"から一歩踏み出すための考え方](https://zenn.dev/ritou/articles/4a5d6597a5f250)

---

ここからは書籍Webを支える技術を参考にする



## 3章 Webのアーキテクチャスタイル

![アーキテクチャスタイル](image/アーキテクチャスタイル.png)

実際のシステムは具体的なアーキテクチャを持っている。そのアーキテクチャを設計するときにただ闇雲に作っているのではなく**アーキテクチャ設計の指針、作法、流儀、つまりアーキテクチャスタイルを適用する**
システムのアーキテクチャを決定する際の羅針盤となるのがアーキテクチャスタイル

アーキテクチャ: ブラウザ/サーバ/プロキシ/HTTP/URI/HTML
↓
アーキテクチャスタイル（マクロ）アーキテクチャパターン): REST/MVC(Model-View-Controller)/パイプフィルタ/イベントシステム


## デザインパターン

デザインパターン（マイクロアーキテクチャパターン）といい、アーキテクチャスタイルよりも粒度の小さいクラスの設計様式を指す

## healthCheck
[参考URL](https://devblog.thebase.in/entry/2019/03/06/110000)

healthCheckはAPIの通信ができるかといった外形監視と呼ばれる。  

api&DBまでを確認するのが基本っぽい。
しかし、クラウドなど（AWS）でデフォルト確認などできるのであればDBまでは不要かも。


運用しているYELL BANKというサービスは、以前公開した『ECS(Fargate)でコンテナアプリケーションを動かすための設定情報の扱い方』という記事でも紹介した通り、コンテナー上で動作することを前提としたアプリケーションとして機能提供しています。 コンテナー  内で動かすアプリケーションにおいても、外形監視は重要と感じていますが、


## query

>はい、OKです。
>これらのqueryは基本的にAND条件が多いです。例えばYouTube APIとかでもqueryは色々ありますが、複数指定した場合はそれらのANDでの結果が返ってきますね。
>ORにする場合は複雑なcombinatorとかをqueryで実現する実装が必要だったりして面倒なのですが、とりあえず今回の件ではどちらも考慮したものでOKです
>矛盾する２つのqueryを指定されたらエラーを返す、みたいなAPIもよくあります。(例えば日付の絶対指定と相対指定を両方提供しているAPIで両方値が入っていたケースなど)