# browser
[参考URL](https://zenn.dev/silverbirder/articles/e10295948e17ca)

ブラウザの仕組みについて記載する。

## 同期処理はブラウザはしてほしくない

同期的にブロックする処理があると、ブラウザでは大きな問題となる。
JSは基本的にブラウザのメインスレッド（UIスレッドとも呼ばれる）で実行されるため。
メインスレッドは表示の更新といったUIに関する処理も行なっているためメインスレッドが他の処理で占有されると表示が更新されなくなりフリーズしたようになる。



## ブラウザにデータを保存する他の技術

|         | sessionStorage | localStorage | cookie |
| ------- | -------------- | ------------ | ------ |
| データ保存期間 | ウインドウ・タブを閉じるまで | 永続的 | 指定できる  |
| 保存容量 | 5~10MB | 5~10MB | 最大4KB |
| 別ウィンドウ/別タブからのアクセス | 不可 |可 | 可 |

## sessionStorage

sessionStorageはブラウザに保存するタイプ。
診断コンテンツなど、ページを閲覧している間だけ一時的にデータを保存しておきたい時など使用する。

- **ブラウザを閉じるとデータがクリアされる。**
- 同じタブ内の別ページはデータが保持される
- 別タブはデータが保持されない。
- 別ウィンドウにはデータは渡せない。

## localStorage

localStorageはWebStorageのひとつで、ユーザのPCに保存するタイプ。
localStorageやcookieは反対にセッションが途切れてもデータを残しておけるので、
たとえばIDやパスワードを保存して簡単にログインできる仕組みや、ECサイトでショッピングカートに商品のデータを保存する時などに使われています。

## session(セッション)

- セッションIDの**生成方法はHTTPの仕様として定まっていない。**サーバー側の実装に依存する
- セッションはWebサーバ側で保持する（セッション情報はDBやファイルなどで管理・保持する）

ブラウザ側ではCookie（クッキー）にセッション情報が保存されます。Cookie以外の方法もありますが、現在ではCookieを利用するのが主流です。
またCookieに保存するセッション情報は詳しい個人情報などではなく、次項から説明するセッション管理で使用するセッションIDだけ保存します。
そのためクライアント側ではセッションIDしか見えないため、万が一改ざんされても大きな影響はありません。


セッションID生成方法
- 
各プログラム言語にはメジャーなセッションライブラリがあり、セッションID生成には、それらを使うことが多い
それらのライブラリの多くのデフォルトの実装は、セッションIDとしてユニークで推測しずらい値を生成し、それをキーとして「ユーザーID」などのユーザーデータを紐付けて、ローカルファイルやメモリ上にキーバリューデータとして保存しておく
そして、ブラウザーからアクセスがあった場合は、クッキーからセッションIDを読み取り、セッションIDをキーに、キーバリューデータから該当するユーザーデータを復元する
キーバリューデータをサーバーのローカルファイルやメモリに保存するため、サーバーを複数設置して負荷分散させた場合、接続毎に接続先のサーバーが変わってしまうので、セッションが維持できなくなってしまう
なので、どのサーバーにアクセスしても適切なユーザーデータが復元できるように、キーバリューデータをローカルではなく、データベースに格納するようにすることも多い

### Expressでのセッション管理

Expressには、以下の2つのセッションモジュールがある
- cookie-session
- express-session
cookie-sessionはCookieにセッションデータを保存するミドルウェアです。
express-sessionはCookieにセッションIDのみを保存して、セッションデータは別のストレージに保存するミドルウェアです

## スクロール位置の復元
[Next.jsはどうやってスクロール位置を復元するのか](https://zenn.dev/akfm/articles/next-js-scroll-restore)

デフォルトでのブラウザ挙動
>ブラウザのhistory entryに格納されるstateにはscroll position dataというものがあり、「scroll restoration modeがautoならscroll position dataをもとにuser agentはスクロール位置を復元することができる」とされています。scroll restoration modeはhistory.scrollRestoration にauto(初期値)かmanualを代入することで設定できます。



